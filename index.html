<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§å¤©æ°£è¬èƒ½æ›† (Pro)</title>
    
    <meta name="theme-color" content="#0984e3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwic3JjIjoiYXBwLWljb24tNTEyeDUxMi5wbmciLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzaXplcyI6IjUxMng1MTIiLCJzcmMiOiJhcHAtaWNvbi01MTJ4NTEyLnBuZyIsInR5cGUiOiJpbWFnZS9wbmcifV0sImJhY2tncm91bmRfY29sb3IiOiIjZmZmZmZmIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJuYW1lIjoi5pZ6aF5aSp5rCj6JCs6IO95puGIiwic2hvcnRfbmFtZSI6Iuaizuua1jOWkqeawoyIsInN0YXJ0X3VybCI6Ii4iLCJ0aGVtZV9jb2xvciI6IiMwOTg0ZTMifQ==">

    <style>
        :root {
            /* é è¨­ä¸»é¡Œ (è—è‰²) */
            --main-color: #0984e3;
            --bg-gradient: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            
            --card-bg-light: #fff;
            --card-bg-dark: rgba(30, 30, 40, 0.85);
            --text-main-light: #333;
            --text-main-dark: #fff;
            --container-bg-light: rgba(255, 255, 255, 0.95);
            --container-bg-dark: rgba(0, 0, 0, 0.6);
            --pin-color: #ff7675; 
            /* ğŸŒŸ æ–°å¢é¡è‰²è®Šæ•¸ */
            --severe-color: #d63031;
            --warning-color: #fdcb6e;
            --info-color: #0984e3;
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: var(--text-main-light);
            transition: background 0.5s ease, color 0.5s ease;
            overflow-x: hidden;
        }

        /* Dark Mode Settings */
        body.dark-mode { 
            background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e) !important; 
            color: var(--text-main-dark); 
        }
        body.dark-mode .container { 
            background: var(--container-bg-dark); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.8); 
        }

        .container {
            background: var(--container-bg-light); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); text-align: center; max-width: 1100px; width: 100%; min-height: 600px; transition: background 0.5s ease;
        }
        
        /* ğŸŒŸ è¼‰å…¥èˆ‡éª¨æ¶å±å„ªåŒ– */
        #loader { display: none; margin: 20px auto; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--main-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* ç°¡æ˜“éª¨æ¶å±æ¨£å¼ */
        .skeleton-card { background: #f0f0f0; border-radius: 15px; height: 250px; width: 240px; animation: pulse-bg 1.5s infinite alternate; }
        body.dark-mode .skeleton-card { background: #333; }
        @keyframes pulse-bg { 0% { opacity: 0.5; } 100% { opacity: 1; } }


        /* Clock & Controls */
        .clock-area { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        body.dark-mode .clock-area { border-bottom: 1px solid rgba(255,255,255,0.2); }
        .greeting { font-size: 1.2em; color: var(--main-color); font-weight: bold; margin-bottom: 5px; }
        body.dark-mode .greeting { color: #74b9ff; }
        .real-time-clock { font-size: 2.8em; font-weight: bold; font-family: monospace; letter-spacing: 2px; margin: 10px 0;}
        .updated-time { font-size: 0.85em; color: #666; margin-top: 5px; } /* ğŸŒŸ æ–°å¢æ›´æ–°æ™‚é–“ */
        body.dark-mode .updated-time { color: #ccc; }
        
        /* è·¨å¹´å€’æ•¸ UI æ¨£å¼ */
        .countdown-text {  
            font-size: 1.1em;  
            color: #e17055;  
            font-weight: bold;  
            margin: 10px 0;  
            background: rgba(225, 112, 85, 0.1);  
            display: inline-block;  
            padding: 5px 15px;  
            border-radius: 20px;
            white-space: nowrap;  
        }
        body.dark-mode .countdown-text { color: #ff7675; background: rgba(255, 118, 117, 0.2); }
        
        .astro-info { display: flex; justify-content: center; gap: 20px; font-size: 0.95em; color: #666; margin-top: 10px; flex-wrap: wrap; }
        body.dark-mode .astro-info { color: #b2bec3; }

        .controls { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        select, button { padding: 10px 18px; font-size: 16px; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; outline: none; transition: 0.3s; }
        
        body.dark-mode select { background-color: #2d3436; color: #fff; border-color: #555; }
        body.dark-mode option { background-color: #2d3436; color: #fff; }
        
        .btn-query { background-color: var(--main-color); color: white; border: none; font-weight: bold; }
        .btn-copy { background-color: #00b894; color: white; border: none; font-weight: bold; }
        .btn-mode { background-color: #636e72; color: white; border: none; font-weight: bold; }
        
        /* ğŸŸ¢ ä¸»é¡Œè‰²é¸æ“‡å™¨ */
        .theme-selector { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 10px; 
            margin-top: 10px;
        }
        .color-btn {  
            width: 25px; height: 25px; border-radius: 50%;  
            border: 2px solid transparent;  
            cursor: pointer;  
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);  
            transition: transform 0.2s, box-shadow 0.2s;  
        }
        .theme-blue { background: #0984e3; }
        .theme-green { background: #00b894; }
        .theme-purple { background: #6c5ce7; }
        .theme-pink { background: #e84393; }

        .color-btn.active {  
            box-shadow: 0 0 0 3px #fff, 0 0 0 5px var(--main-color);  
            transform: scale(1.1);  
        }  
        body.dark-mode .color-btn.active {  
            box-shadow: 0 0 0 3px #222, 0 0 0 5px var(--main-color);  
        }


        /* Forecast Cards */
        #forecast-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; min-height: 200px; }
        .weather-card {
            background: var(--card-bg-light); padding: 20px; border-radius: 15px; width: 240px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-top: 5px solid var(--main-color);
            transition: transform 0.2s; color: var(--text-main-light);
            display: flex; flex-direction: column; align-items: center; animation: fadeIn .5s ease-out;
        }
        .temp-range { color: #e17055; font-weight: bold; font-size: 1.3em; margin-top: 5px;}
        
        /* ğŸŒŸ èˆ’é©åº¦æ¢æ¨£å¼ */
        .ci-text { 
            font-size: .9em; 
            color: #fff; 
            margin: 8px 0; 
            background: #b2bec3; 
            padding: 6px 15px; 
            min-height: 38px; 
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px; 
            font-weight: bold; 
            width: 90%; 
            line-height: 1.2; 
        }
        .rain { color: var(--main-color); font-weight: bold; margin-top: 8px; font-size: .95em;}
        /* ğŸŒŸ æ–°å¢æ¿•åº¦/é«”æ„Ÿæº«åº¦æ¨£å¼ */
        .details-row { font-size: 0.85em; color: #666; margin-top: 5px; }
        body.dark-mode .details-row { color: #ccc; }


        /* ğŸš¨ æ°£è±¡ç‰¹å ± Marquee æ¨£å¼ */
        #alert-marquee { 
            width: 95%; 
            margin: 10px auto 20px auto; 
            background-color: var(--severe-color); /* ä½¿ç”¨è®Šæ•¸ */
            color: white; 
            font-weight: bold; 
            z-index: 999; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            display: none; 
            overflow: hidden; 
            font-size: 1.1em; 
            cursor: pointer; 
            transition: all 0.2s; 
            text-align: center; 
            border-radius: 10px; 
        }
        .alert-summary { padding: 10px 15px; line-height: 1.4; display: flex; justify-content: center; align-items: center; }
        #alertDetails { display: none; padding: 15px 20px; background-color: rgba(0,0,0,0.2); backdrop-filter: blur(5px); max-height: 300px; overflow-y: auto; text-align: left; font-size: 0.9em; }
        .typhoon-link { display: block; background: rgba(255, 255, 255, 0.2); padding: 5px; margin-top: 10px; border-radius: 5px; text-decoration: none; color: #ffeb3b; } /* ğŸŒŸ é¢±é¢¨é€£çµæ¨£å¼ */


        /* ---------------------------------- */
        /* ğŸŒŸ åœ°éœ‡è­¦å ±å€å¡Šæ¨£å¼ (å·²ç§»é™¤ï¼Œæ­¤æ¨£å¼åƒ…ç‚ºå ä½ç¬¦) ğŸŒŸ */
        /* ---------------------------------- */
        #earthquake-alert {
            display: none; 
        }
        /* ---------------------------------- */

        /* Maps Section and Grid Layout */
        .map-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,.1); text-align: center; }
        body.dark-mode .map-section { border-top: 1px solid rgba(255,255,255,.1); }
        
        /* ğŸŒŸ æ ¸å¿ƒä¿®å¾©ï¼šä½¿ç”¨ Grid ä½ˆå±€ï¼Œè®“é …ç›®æ°´å¹³å±…ä¸­ï¼Œä¸¦ç¢ºä¿éŸ¿æ‡‰å¼é©æ‡‰ */
        #maps-wrapper {  
            display: grid;  
            /* ä½¿ç”¨ auto-fit è®“ Grid é …ç›®è‡ªå‹•é©æ‡‰ä¸¦æ›è¡Œ (minmax(æœ€å°å¯¬åº¦, å½ˆæ€§å¯¬åº¦)) */
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px;  
            margin: 0 auto; /* è®“ Grid å®¹å™¨æœ¬èº«åœ¨çˆ¶å…ƒç´ ä¸­å±…ä¸­ */
            overflow-x: hidden; 
            padding-bottom: 0;
            white-space: normal;
        }

        /* ğŸŒŸ ä¿®å¾©ï¼šè®“ç¶²æ ¼å…§éƒ¨çš„å­é …ç›®ï¼ˆåœ°åœ–å¡ç‰‡ï¼‰åœ¨å…¶å–®å…ƒæ ¼å…§æ°´å¹³å±…ä¸­ */
        .map-box { 
            position: relative; 
            min-width: unset; 
            display: block; 
            white-space: normal;
            justify-self: center; /* é—œéµå±¬æ€§ï¼šè®“å­é …ç›®å±…ä¸­ */
        }
        
        /* åª’é«”æŸ¥è©¢ï¼šç¢ºä¿åœ¨çª„è¢å¹•ä¸Šé©æ‡‰ */
        @media (max-width: 800px) {
             #maps-wrapper {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 500px) {
            #maps-wrapper {
                grid-template-columns: 1fr; 
            }
        }
        /* ---------------------------------- */
        
        .map-box.pinned {
            border: 3px solid var(--pin-color) !important;
            box-shadow: 0 0 15px rgba(255, 118, 117, 0.5);
        }
        .pin-icon {
            position: absolute; top: 10px; right: 10px; font-size: 1.2em; cursor: pointer;
            color: #ccc; transition: color 0.2s; background: rgba(255, 255, 255, 0.5);
            padding: 3px 5px; border-radius: 5px; line-height: 1; z-index: 5;
        }
        .map-box.pinned .pin-icon { color: var(--pin-color); background: rgba(255, 255, 255, 0.9); }
        body.dark-mode .pin-icon { background: rgba(0, 0, 0, 0.5); }
        body.dark-mode .map-box.pinned .pin-icon { background: rgba(0, 0, 0, 0.8); }

        .map-box {  
            max-width: 400px;  
            background: var(--card-bg-light); padding: 15px; border-radius: 15px;  
            box-shadow: 0 5px 15px rgba(0,0,0,.1); width: 100%;
        }
        .map-box h4 { margin: 0 0 10px 0; color: var(--main-color); }
        img.map-img { width: 100%; height: auto; border-radius: 10px; display: block; cursor: pointer; } /* ğŸŒŸ å¢åŠ æ”¾å¤§é è¦½çš„ cursor */

        .footer-note { margin-top: 30px; }

        /* ğŸŒŸ Modal æ¨£å¼ */
        #featuresModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--card-bg-light); padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; text-align: left; position: relative;
        }
        body.dark-mode .modal-content { background: #2d3436; color: var(--text-main-dark); }
        .modal-content h3 { margin-top: 0; color: var(--main-color); border-bottom: 2px solid var(--main-color); padding-bottom: 10px; }
        .modal-content ul { padding-left: 20px; list-style-type: disc; }
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer; color: #666; }
        body.dark-mode .close-btn { color: #ccc; }
    </style>
</head>
<body>

    <div class="container" id="mainCard">
        <h2 id="appTitle">WEIå¤©æ°£</h2>

        <div id="alert-marquee" onclick="toggleAlertDetails()" data-state="summary" style="display: none;">
            <div class="alert-summary" id="marqueeText">è®€å–ç½å®³è­¦å ±ä¸­...</div>
            <div id="alertDetails" style="display:none;">
                </div>
        </div>
        
        <div id="earthquake-alert" style="display: none;"></div>
        <div class="clock-area">
            <div class="greeting" id="greetingText">Loading...</div>
            <div class="real-time-clock" id="liveClock">00:00:00</div>
            <div id="liveDate">--</div>
            <div id="updatedTime" class="updated-time"></div> <div id="countdown" class="countdown-text">è¨ˆç®—ä¸­...</div>

            <div class="astro-info">
                <span id="lunarDate">ğŸŒ è¾²æ›†...</span> 
            </div>
        </div>
        
        <div class="controls">
            <select id="citySelect" onchange="getWeather(citySelect.value)">
                <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="è‡ºåŒ—å¸‚" selected>è‡ºåŒ—å¸‚</option>
                <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option><option value="è‡ºå—å¸‚">è‡ºå—å¸‚</option>
                <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option><option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
                <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option><option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option><option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                <option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                <option value="è‡ºæ±ç¸£">è‡ºæ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option><option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
            </select>
            <button class="btn-query" onclick="getWeather(citySelect.value)">ğŸ”„ æŸ¥è©¢</button>
            <button class="btn-copy" onclick="copyWeather()">ğŸ“‹ è¤‡è£½</button>
            <button class="btn-mode" onclick="toggleTheme(this)" id="btnMode">ğŸŒ™ å¤œé–“</button>
            <button class="btn-mode" onclick="autoLocate()">ğŸ“ è‡ªå‹•å®šä½</button> <button class="btn-mode" onclick="openFeaturesModal()">â„¹ï¸ ç¶²ç«™åŠŸèƒ½</button> <div class="theme-selector" id="themeSelector">
                <div class="color-btn theme-blue active" data-color="#0984e3" data-gradient="linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)" onclick="toggleTheme(this)"></div>
                <div class="color-btn theme-green" data-color="#00b894" data-gradient="linear-gradient(135deg, #55efc4 0%, #00b894 100%)" onclick="toggleTheme(this)"></div>
                <div class="color-btn theme-purple" data-color="#6c5ce7" data-gradient="linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%)" onclick="toggleTheme(this)"></div>
                <div class="color-btn theme-pink" data-color="#e84393" data-gradient="linear-gradient(135deg, #fd79a8 0%, #e84393 100%)" onclick="toggleTheme(this)"></div>
            </div>
        </div>
        
        <div class="loader" id="loader"></div>
        <div id="forecast-container">
             <div class="skeleton-card"></div>
             <div class="skeleton-card"></div>
             <div class="skeleton-card"></div>
        </div> 
        
        <div id="mapModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; justify-content:center; align-items:center;" onclick="closeMapModal()">
            <img id="modalImage" style="max-width:90%; max-height:90%; object-fit:contain;" onclick="event.stopPropagation();">
            <button onclick="closeMapModal()" style="position:absolute; top:20px; right:30px; font-size:30px; color:white; background:none; border:none; cursor:pointer;">&times;</button>
        </div>


        <div class="map-section">
            <h3>ğŸŒ å…¨å°å¤©æ°£å¯¦æ³</h3>
            <div class="maps-wrapper" id="maps-wrapper">
                
                <div class="map-box" id="map-box-tempMap" data-map-id="tempMap">
                    <h4>ğŸŒ¡ï¸ æº«åº¦åˆ†å¸ƒ</h4>
                    <span class="pin-icon" onclick="togglePinMap('tempMap', event)">ğŸ“Œ</span>
                    <a id="tempLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg" target="_blank"><img id="tempMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡æº«åº¦è³‡æ–™';"></a>
                    <a id="tempBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>
                
                <div class="map-box" id="map-box-rainMap" data-map-id="rainMap">
                    <h4>â˜” å¤§é–“è·æ—¥ç´¯ç©é›¨é‡</h4>
                    <span class="pin-icon" onclick="togglePinMap('rainMap', event)">ğŸ“Œ</span>
                    <a id="rainLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg" target="_blank"><img id="rainMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg" onclick="openMapModal(this.src)" target="_blank" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é›¨é‡è³‡æ–™';"></a>
                    <a id="rainBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>
                
                <div class="map-box" id="map-box-detailedRainMap" data-map-id="detailedRainMap"> 
                    <h4>ğŸŒ§ï¸ å°é–“è·æ—¥ç´¯ç©é›¨é‡</h4>
                    <span class="pin-icon" onclick="togglePinMap('detailedRainMap', event)">ğŸ“Œ</span>
                    <a id="detailedRainLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-002.jpg" target="_blank"><img id="detailedRainMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-002.jpg" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡ç²¾ç´°é›¨é‡è³‡æ–™';"></a>
                    <a id="detailedRainBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-002.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                <div class="map-box" id="map-box-infraredMap" data-map-id="infraredMap">
                    <h4>â˜ï¸ ç´…å¤–ç·šè¡›æ˜Ÿé›²åœ–</h4>
                    <span class="pin-icon" onclick="togglePinMap('infraredMap', event)">ğŸ“Œ</span>
                    <a id="infraredLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-B0028-003.jpg" target="_blank"><img id="infraredMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-B0028-003.jpg" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡ç´…å¤–ç·šé›²åœ–è³‡æ–™';"></a>
                    <a id="infraredBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-B0028-003.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                <div class="map-box" id="map-box-enhancedInfraredMap" data-map-id="enhancedInfraredMap">
                    <h4>ğŸŒŸ å¼·åŒ–è¡›æ˜Ÿé›²åœ– (HD)</h4>
                    <span class="pin-icon" onclick="togglePinMap('enhancedInfraredMap', event)">ğŸ“Œ</span>
                    <a id="enhancedInfraredLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-C0042-006.jpg" target="_blank"><img id="enhancedInfraredMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-C0042-006.jpg" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡å¼·åŒ–é›²åœ–è³‡æ–™';"></a>
                    <a id="enhancedInfraredBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-C0042-006.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>
                
                <div class="map-box" id="map-box-surfaceMap" data-map-id="surfaceMap">
                    <h4>ğŸ—ºï¸ åœ°é¢å¤©æ°£åœ–</h4>
                    <span class="pin-icon" onclick="togglePinMap('surfaceMap', event)">ğŸ“Œ</span>
                    <a id="surfaceLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Forecast/F-C0035-001.jpg" target="_blank"><img id="surfaceMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Forecast/F-C0035-001.jpg" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡å¤©æ°£åœ–è³‡æ–™';"></a>
                    <a id="surfaceBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Forecast/F-C0035-001.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>
                
                <div class="map-box" id="map-box-compositeMap" data-map-id="compositeMap"> 
                    <h4>ğŸ“¡ å…¨è‡ºé›·é”æ•´åˆåœ–</h4>
                    <span class="pin-icon" onclick="togglePinMap('compositeMap', event)">ğŸ“Œ</span>
                    <a id="compositeLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0058-003.png" target="_blank"><img id="compositeMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0058-003.png" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡æ•´åˆé›·é”è³‡æ–™';"></a>
                    <a id="compositeBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0058-003.png" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>
                
                <div class="map-box" id="map-box-shulinMap" data-map-id="shulinMap"> 
                    <h4>æ¨¹æ—é›·é”å›æ³¢åœ–</h4>
                    <span class="pin-icon" onclick="togglePinMap('shulinMap', event)">ğŸ“Œ</span>
                    <a id="shulinLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-001.png" target="_blank"><img id="shulinMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-001.png" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é›·é”è³‡æ–™';"></a>
                    <a id="shulinBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-001.png" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                <div class="map-box" id="map-box-nantunMap" data-map-id="nantunMap">
                    <h4>å—å±¯é›·é”å›æ³¢åœ–</h4>
                    <span class="pin-icon" onclick="togglePinMap('nantunMap', event)">ğŸ“Œ</span>
                    <a id="nantunLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-002.png" target="_blank"><img id="nantunMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-002.png" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é›·é”è³‡æ–™';"></a>
                    <a id="nantunBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-002.png" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                <div class="map-box" id="map-box-linyuanMap" data-map-id="linyuanMap">
                    <h4>æ—åœ’é›·é”å›æ³¢åœ–</h4>
                    <span class="pin-icon" onclick="togglePinMap('linyuanMap', event)">ğŸ“Œ</span>
                    <a id="linyuanLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-003.png" target="_blank"><img id="linyuanMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-003.png" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é›·é”è³‡æ–™';"></a>
                    <a id="linyuanBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-003.png" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                 <div class="map-box" id="map-box-globalInfraredMap" data-map-id="globalInfraredMap">
                    <h4>ğŸŒ å…¨çƒé»‘ç™½ç´…å¤–ç·šé›²åœ–</h4>
                    <span class="pin-icon" onclick="togglePinMap('globalInfraredMap', event)">ğŸ“Œ</span>
                    <a id="globalInfraredLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-B0033-001.jpg" target="_blank"><img id="globalInfraredMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-B0033-001.jpg" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡å…¨çƒé›²åœ–è³‡æ–™';"></a>
                    <a id="globalInfraredBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-B0033-001.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                <div class="map-box" id="map-box-enhancedGlobalMap" data-map-id="enhancedGlobalMap">
                    <h4>ğŸŒ é«˜è§£æå…¨çƒè‰²èª¿å¼·åŒ–é›²åœ–</h4>
                    <span class="pin-icon" onclick="togglePinMap('enhancedGlobalMap', event)">ğŸ“Œ</span>
                    <a id="enhancedGlobalLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-C0042-005.jpg" target="_blank"><img id="enhancedGlobalMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-C0042-005.jpg" onclick="openMapModal(this.src)" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é«˜è§£æå…¨çƒé›²åœ–è³‡æ–™';"></a>
                    <a id="enhancedGlobalBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-C0042-005.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>
            </div>
        </div>

        <div class="footer-note">
            âš ï¸ å‚™è¨»ï¼šå„ç¸£å¸‚é å ±ä¿‚ä»¥å„ç¸£å¸‚æ”¿åºœæ‰€åœ¨åœ°é™„è¿‘ç‚ºé å ±åƒè€ƒä½ç½®ã€‚
        </div>
    </div>
    
    <div id="featuresModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:2000; justify-content:center; align-items:center;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeFeaturesModal()">&times;</span>
            <div id="lockedFeatures">
                <h3>âœ¨ WEIå¤©æ°£ æ‡‰ç”¨ç¨‹å¼åŠŸèƒ½ä¸€è¦½ âœ¨</h3>
                
                <h4>ğŸ“‹ æ ¸å¿ƒé å ±èˆ‡è³‡è¨Š</h4>
                <ul>
                    <li>å¤šæ—¥é å ±å¡ç‰‡ï¼šé¡¯ç¤ºæ‰€é¸ç¸£å¸‚æœªä¾† 3 å€‹é å ±æ™‚æ®µçš„è³‡è¨Šã€‚</li>
                    <li>èˆ’é©åº¦æç¤ºï¼šæ ¹æ“šé å ±æº«å·®è‡ªå‹•çµ¦å‡ºã€Œå¯’å†·ã€ã€ã€Œèˆ’é©ã€ã€ã€Œæ‚¶ç†±ã€ç­‰é¡è‰²æç¤ºã€‚</li>
                    <li>å»¶ä¼¸è³‡è¨Šï¼šé å ±å¡ç‰‡é¡å¤–é¡¯ç¤ºé«”æ„Ÿæº«åº¦ã€ç›¸å°æ¿•åº¦ï¼Œæä¾›æ›´å…¨é¢çš„åƒè€ƒã€‚</li>
                    <li>æ™‚é–“èˆ‡æ›†æ³•ï¼šé¡¯ç¤ºå³æ™‚æ™‚é˜ã€åœ‹æ›†/è¾²æ›†æ—¥æœŸï¼Œä»¥åŠæº–ç¢ºçš„è·¨å¹´å€’æ•¸è¨ˆæ™‚ã€‚</li>
                    <li>è³‡æ–™ç™¼å¸ƒæ™‚é–“ï¼šé¡¯ç¤ºæ°£è±¡æ•¸æ“šçš„æœ€å¾Œç™¼å¸ƒæ™‚é–“ï¼Œç¢ºä¿è³‡è¨Šå³æ™‚æ€§ã€‚</li>
                </ul>

                <h4>ğŸš¨ è­¦å ±èˆ‡é˜²ç½</h4>
                <ul>
                    <li>æ°£è±¡ç‰¹å ±æ»¾å‹•æ¢ï¼šå¯¦æ™‚ç²å–ä¸¦é¡¯ç¤º CWA ç™¼å¸ƒçš„å„ç¨®æ°£è±¡ç‰¹å ±ï¼ˆä½æº«ã€å¤§é›¨ã€å¼·é¢¨ç­‰ï¼‰ï¼Œé»æ“Šå¯æŸ¥çœ‹è©³æƒ…ã€‚</li>
                    <li>é¢±é¢¨é€£çµï¼šè‹¥æœ‰é¢±é¢¨è­¦å ±ï¼Œè­¦å ±è©³æƒ…ä¸­æœƒå‹•æ…‹é¡¯ç¤ºé¢±é¢¨è·¯å¾‘åœ–é€£çµã€‚</li>
                </ul>

                <h4>ğŸ—ºï¸ åœ°åœ–èˆ‡å·¥å…·</h4>
                <ul>
                    <li>12 å¼µå¯¦æ³åœ°åœ–ï¼šåŒ…å«æº«åº¦ã€é›¨é‡ã€é›·é”å›æ³¢ã€å„ç¨®è¡›æ˜Ÿé›²åœ–ç­‰ 12 ç¨® CWA å¯¦æ³åœ–ã€‚</li>
                    <li>åœ°åœ–é‡˜é¸åŠŸèƒ½ï¼šå¯é‡˜é¸ 4 å¼µæœ€å¸¸ç”¨åœ°åœ–åˆ°åˆ—è¡¨é ‚éƒ¨ï¼Œæ–¹ä¾¿å¿«é€Ÿå­˜å–ã€‚</li>
                    <li>åœ°åœ–æ”¾å¤§é è¦½ï¼šé»æ“Šåœ°åœ–åœ–ç‰‡å³å¯é–‹å•Ÿå…¨å±é è¦½ Modalã€‚</li>
                    <li>ä¸»é¡Œåˆ‡æ›ï¼šæ”¯æ´æ—¥é–“/å¤œé–“æ¨¡å¼ä¸€éµåˆ‡æ›ï¼Œä¸¦æä¾›å››ç¨®ä¸»é¡Œé¡è‰²è‡ªè¨‚ã€‚</li>
                    <li>è‡ªå‹•å®šä½ (æŒ‰éˆ•)ï¼šé»æ“Šã€Œè‡ªå‹•å®šä½ã€æŒ‰éˆ•ï¼Œå¯ä½¿ç”¨ç€è¦½å™¨å®šä½æœ€è¿‘ç¸£å¸‚ã€‚</li>
                </ul>
            </div>
        </div>
    </div>


    <script>
        // ğŸŒŸ è¼”åŠ©å‡½æ•¸ï¼šæ—¥æœŸæ ¼å¼åŒ–
        const formatTime = (isoString) => {
            if (!isoString) return '--';
            const date = new Date(isoString);
            return `${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        };


        let weatherReportText = "";
        let clockInterval;
        let activeWarningData = [];    
        let pinnedMaps = []; 

        // ğŸš¨ API Key
        const apiKey = 'CWA-F34E2B5F-6154-4EBF-987B-9E10BE9C365C';    

        const cityCoords = {
            "è‡ºåŒ—å¸‚": {lat: 25.0329, lon: 121.5654, CWA_ID: '63'}, "åŸºéš†å¸‚": {lat: 25.1276, lon: 121.7391, CWA_ID: '67'},
            "æ–°åŒ—å¸‚": {lat: 25.0169, lon: 121.4627, CWA_ID: '65'}, "å®œè˜­ç¸£": {lat: 24.7021, lon: 121.7377, CWA_ID: '10002'},
            "æ¡ƒåœ’å¸‚": {lat: 24.9936, lon: 121.3009, CWA_ID: '68'}, "æ–°ç«¹å¸‚": {lat: 24.8138, lon: 120.9674, CWA_ID: '10018'},
            "æ–°ç«¹ç¸£": {lat: 24.8396, lon: 121.0180, CWA_ID: '10004'}, "è‹—æ —ç¸£": {lat: 24.5601, lon: 120.8214, CWA_ID: '10005'},
            "è‡ºä¸­å¸‚": {lat: 24.1477, lon: 120.6736, CWA_ID: '66'}, "å½°åŒ–ç¸£": {lat: 24.0517, lon: 120.5160, CWA_ID: '10007'},
            "å—æŠ•ç¸£": {lat: 23.9609, lon: 120.6951, CWA_ID: '10008'}, "é›²æ—ç¸£": {lat: 23.7092, lon: 120.4313, CWA_ID: '10009'},
            "å˜‰ç¾©å¸‚": {lat: 23.4800, lon: 120.4491, CWA_ID: '10020'}, "å˜‰ç¾©ç¸£": {lat: 23.4518, lon: 120.2554, CWA_ID: '10010'},
            "è‡ºå—å¸‚": {lat: 22.9997, lon: 120.2270, CWA_ID: '69'}, "é«˜é›„å¸‚": {lat: 22.6272, lon: 120.3014, CWA_ID: '64'},
            "å±æ±ç¸£": {lat: 22.5519, lon: 120.5487, CWA_ID: '10013'}, "è‡ºæ±ç¸£": {lat: 22.7972, lon: 121.0713, CWA_ID: '10014'},
            "èŠ±è“®ç¸£": {lat: 23.9871, lon: 121.6015, CWA_ID: '10015'}, "æ¾æ¹–ç¸£": {lat: 23.5711, lon: 119.5793, CWA_ID: '10016'},
            "é‡‘é–€ç¸£": {lat: 24.3293, lon: 118.3204, CWA_ID: '09020'}, "é€£æ±Ÿç¸£": {lat: 26.1512, lon: 119.9288, CWA_ID: '09007'}
        };

        // ğŸŒŸ æ ¸å¿ƒ API å°è£å‡½æ•¸ (å„ªåŒ–é» 7)
        async function fetchCWAData(dataid, params = {}) {
            const queryString = new URLSearchParams({
                Authorization: apiKey,
                format: 'JSON',
                ...params
            }).toString();
            const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/${dataid}?${queryString}`;

            try {
                const response = await fetch(url);
                if (response.type === 'opaque' || response.status === 0 || response.status === 408) {
                    throw new Error("ç¶²è·¯é€£ç·šéŒ¯èª¤ (CORS/Timeout)ã€‚");
                }
                if (!response.ok) {
                    if (response.status === 401) throw new Error("API Key ç„¡æ•ˆæˆ–éæœŸ");
                    throw new Error(`æœå‹™éŒ¯èª¤: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Fetch API ${dataid} å¤±æ•—:`, error);
                throw error;
            }
        }

        // ğŸŒŸ è‡ªå‹•å®šä½ (å„ªåŒ–é» 20) - å‡½æ•¸ä¿ç•™ï¼Œç”±æŒ‰éˆ•è§¸ç™¼
        function autoLocate() {
            if (!navigator.geolocation) {
                alert("æŠ±æ­‰ï¼Œæ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒåœ°ç†ä½ç½®å®šä½ã€‚è«‹æ‰‹å‹•é¸æ“‡ç¸£å¸‚ã€‚");
                return;
            }
            document.getElementById('greetingText').innerText = "ğŸ“ æ­£åœ¨å˜—è©¦è‡ªå‹•å®šä½...";
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    let nearestCity = null;
                    let minDistance = Infinity;

                    for (const city in cityCoords) {
                        const cityLat = cityCoords[city].lat;
                        const cityLon = cityCoords[city].lon;
                        // ç°¡å–®çš„æ­å¹¾é‡Œå¾—è·é›¢å¹³æ–¹
                        const distanceSq = Math.pow(lat - cityLat, 2) + Math.pow(lon - cityLon, 2);
                        if (distanceSq < minDistance) {
                            minDistance = distanceSq;
                            nearestCity = city;
                        }
                    }

                    if (nearestCity) {
                        document.getElementById('citySelect').value = nearestCity;
                        getWeather(nearestCity);
                        alert(`âœ… å®šä½æˆåŠŸï¼ç›®å‰ä½æ–¼ï¼š${nearestCity}`);
                        localStorage.setItem('myWeatherCity', nearestCity); 
                    } else {
                        alert("âš ï¸ ç„¡æ³•æ‰¾åˆ°æœ€è¿‘çš„ç¸£å¸‚ã€‚è«‹æ‰‹å‹•é¸æ“‡ã€‚");
                    }
                },
                (error) => {
                    console.error("å®šä½å¤±æ•—:", error);
                    alert("å®šä½å¤±æ•—æˆ–æ‚¨æ‹’çµ•äº†ä½ç½®è«‹æ±‚ã€‚è«‹æ‰‹å‹•é¸æ“‡ç¸£å¸‚ã€‚");
                    getWeather(document.getElementById('citySelect').value); 
                },
                { enableHighAccuracy: false, timeout: 5000, maximumAge: 0 }
            );
        }

        // ğŸŒŸ åœ°åœ–æ”¾å¤§é è¦½ (å„ªåŒ–é» 3)
        function openMapModal(src) {
            const modal = document.getElementById('mapModal');
            document.getElementById('modalImage').src = src;
            modal.style.display = 'flex';
        }
        function closeMapModal() {
            document.getElementById('mapModal').style.display = 'none';
            document.getElementById('modalImage').src = '';
        }

        // ğŸŒŸ ç¶²ç«™åŠŸèƒ½ä»‹ç´¹ Modal 
        function openFeaturesModal() {
            document.getElementById('featuresModal').style.display = 'flex';
        }

        function closeFeaturesModal() {
            document.getElementById('featuresModal').style.display = 'none';
        }


        function refreshMaps() {
            // è¼‰å…¥åœ°åœ–å’Œé›·é”åœ–ï¼ˆåœ–ç‰‡ï¼‰
            const now = new Date().getTime();
            document.getElementById('tempMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg?t=${now}`;
            document.getElementById('rainMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg?t=${now}`;
            document.getElementById('detailedRainMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-002.jpg?t=${now}`;
            document.getElementById('infraredMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-B0028-003.jpg?t=${now}`;
            document.getElementById('enhancedInfraredMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-C0042-006.jpg?t=${now}`;
            document.getElementById('surfaceMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Forecast/F-C0035-001.jpg?t=${now}`;
            document.getElementById('compositeMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0058-003.png?t=${now}`;
            document.getElementById('shulinMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-001.png?t=${now}`;
            document.getElementById('nantunMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-002.png?t=${now}`;
            document.getElementById('linyuanMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-003.png?t=${now}`;
            document.getElementById('globalInfraredMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-B0033-001.jpg?t=${now}`;
            document.getElementById('enhancedGlobalMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-C0042-005.jpg?t=${now}`; 
        }

        function toggleAlertDetails() {
            const marquee = document.getElementById('alert-marquee');
            const details = document.getElementById('alertDetails');
            const currentState = marquee.getAttribute('data-state');

            if (currentState === 'summary' && activeWarningData.length > 0) {
                let detailHtml = activeWarningData.map(alert => {
                    const formattedContent = alert.content.replace(/ã€‚/g, 'ã€‚<br>');
                    let typhoonLink = '';
                    if (alert.title.includes('é¢±é¢¨')) { 
                        typhoonLink = `<a href="https://www.cwa.gov.tw/V8/C/P/Typhoon/TY_PASS.html" target="_blank" class="typhoon-link">æŸ¥çœ‹é¢±é¢¨è·¯å¾‘åœ– &raquo;</a>`;
                    }

                    return `<div class="alert-item">
                        <span class="alert-item-title">${alert.title}</span>
                        <span style="font-size:0.8em; color:#bbb;">ç™¼å¸ƒæ™‚é–“: ${alert.time}</span><br>
                        <span class="alert-item-content">${formattedContent}</span>
                        ${typhoonLink}
                    </div>`;
                }).join('');
                
                details.innerHTML = detailHtml;
                details.style.display = 'block';
                marquee.setAttribute('data-state', 'detailed');
            } else {
                details.style.display = 'none';
                marquee.setAttribute('data-state', 'summary');
            }
        }

        function togglePinMap(mapId, event) {
            if (event) event.stopPropagation();

            const mapBox = document.getElementById(`map-box-${mapId}`);
            const isPinned = mapBox.classList.contains('pinned');

            if (isPinned) {
                mapBox.classList.remove('pinned');
                pinnedMaps = pinnedMaps.filter(id => id !== mapId);
                alert(`${mapBox.querySelector('h4').textContent.replace(/.* /,'')} å·²å–æ¶ˆç½®é ‚ï¼Œå°‡å›åˆ°åŸå§‹ä½ç½®ã€‚`);
            } else {
                if (pinnedMaps.length >= 4) {
                    alert('æœ€å¤šåªèƒ½é‡˜é¸ 4 å¼µåœ°åœ–ï¼Œè«‹å…ˆå–æ¶ˆé‡˜é¸å…¶ä»–åœ°åœ–ã€‚');
                    return;
                }
                
                mapBox.classList.add('pinned');
                pinnedMaps.push(mapId);
                alert(`${mapBox.querySelector('h4').textContent.replace(/.* /,'')} å·²ç½®é ‚ï¼`);
            }

            localStorage.setItem('pinnedMaps', JSON.stringify(pinnedMaps));
            reorderMaps();
        }

        function reorderMaps() {
            const wrapper = document.getElementById('maps-wrapper');
            const allMaps = Array.from(wrapper.querySelectorAll('.map-box'));
            
            const originalOrderIds = [
                'tempMap', 'rainMap', 'detailedRainMap', 'infraredMap', 
                'enhancedInfraredMap', 'surfaceMap', 'compositeMap', 
                'shulinMap', 'nantunMap', 'linyuanMap', 'globalInfraredMap', 'enhancedGlobalMap' 
            ];
            
            allMaps.forEach(map => wrapper.removeChild(map));

            const pinnedMapElements = [];
            const unpinnedMapElements = [];
            
            allMaps.forEach(map => {
                const mapId = map.getAttribute('data-map-id');
                if (pinnedMaps.includes(mapId)) {
                    map.classList.add('pinned');
                    pinnedMapElements.push(map);
                } else {
                    map.classList.remove('pinned');
                    unpinnedMapElements.push(map);
                }
            });

            unpinnedMapElements.sort((a, b) => {
                return originalOrderIds.indexOf(a.getAttribute('data-map-id')) - originalOrderIds.indexOf(b.getAttribute('data-map-id'));
            });
            
            pinnedMapElements.sort((a, b) => {
                return pinnedMaps.indexOf(a.getAttribute('data-map-id')) - pinnedMaps.indexOf(b.getAttribute('data-map-id'));
            });

            pinnedMapElements.forEach(map => wrapper.appendChild(map));
            unpinnedMapElements.forEach(map => wrapper.appendChild(map));
        }

        // ğŸŒŸ ç§»é™¤ checkEarthquakeAlert å‡½æ•¸ï¼Œä»¥å–æ¶ˆåœ°éœ‡è­¦å ±åŠŸèƒ½
        async function checkEarthquakeAlert() {
             return;
        }


        async function getWeather(city) {
            const container = document.getElementById('forecast-container');
            const loader = document.getElementById('loader');
            const updatedTimeEl = document.getElementById('updatedTime');

            container.innerHTML = '<div class="skeleton-card"></div><div class="skeleton-card"></div><div class="skeleton-card"></div>'; // ğŸŒŸ è¼‰å…¥éª¨æ¶å±
            loader.style.display = 'block';
            updatedTimeEl.innerText = 'è®€å–æ•¸æ“šä¸­...';
            
            let weatherReportText = `ğŸ“… ${city} å¤©æ°£é å ±ï¼š\n`;
            
            updateAstroInfo(city);
            
            try {
                // F-C0032-001 (ç¸£å¸‚ 36 å°æ™‚é å ±)
                const data = await fetchCWAData('F-C0032-001', { locationName: city });
                
                // ğŸŒŸ å¥å£¯æ€§ï¼šä½¿ç”¨å¯é¸éˆä¾†ç¢ºä¿ safe access
                const locationData = data.records?.location?.[0]; 
                const issuedTime = data.records?.datasetInfo?.issueTime; 

                if (!locationData) {
                     throw new Error("ç„¡æ³•ç²å–é å ±è³‡æ–™ï¼ŒAPI è¿”å›çµæ§‹ç•°å¸¸ã€‚");
                }

                updatedTimeEl.innerText = `è³‡æ–™ç™¼å¸ƒæ™‚é–“: ${formatTime(issuedTime)} (CWA)`; 
                
                const weatherElements = locationData.weatherElement;
                
                container.innerHTML = '';
                
                // é«”æ„Ÿæº«åº¦ (AT), ç›¸å°æ¿•åº¦ (RH) æ•¸æ“šæº–å‚™
                const rhElement = weatherElements.find(el => el.elementName === 'RH');
                const atElement = weatherElements.find(el => el.elementName === 'AT');

                for (let i = 0; i < 3; i++) {
                    const startTimeStr = weatherElements.find(el => el.elementName === 'Wx').time[i].startTime;
                    const endTimeStr = weatherElements.find(el => el.elementName === 'Wx').time[i].endTime;
                    const wx = weatherElements.find(el => el.elementName === 'Wx').time[i].parameter.parameterName;
                    const pop = Math.round(weatherElements.find(el => el.elementName === 'PoP').time[i].parameter.parameterName); 
                    const minT = Math.round(weatherElements.find(el => el.elementName === 'MinT').time[i].parameter.parameterName);
                    const maxT = Math.round(weatherElements.find(el => el.elementName === 'MaxT').time[i].parameter.parameterName);
                    const comfortData = getCustomComfort(minT, maxT);
                    
                    const rh = rhElement?.time[i]?.parameter?.parameterName ? Math.round(rhElement.time[i].parameter.parameterName) : '--'; // ğŸŒŸ å¥å£¯æ€§ï¼šä½¿ç”¨å¯é¸éˆ
                    const at = atElement?.time[i]?.parameter?.parameterName ? Math.round(atElement.time[i].parameter.parameterName) : '--'; // ğŸŒŸ å¥å£¯æ€§ï¼šä½¿ç”¨å¯é¸éˆ

                    let icon = 'â˜ï¸';
                    if (wx.includes('é›·')) icon = 'â›ˆï¸';
                    else if (wx.includes('é›¨')) icon = 'ğŸŒ§ï¸';
                    else if (wx.includes('æ™´')) icon = 'â˜€ï¸';
                    else if (wx.includes('é™°') || wx.includes('é›²')) icon = 'â˜ï¸';

                    const timeString = `${startTimeStr.substring(5, 16)} <br>~<br> ${endTimeStr.substring(5, 16)}`;
                    const copyTime = `${startTimeStr.substring(5, 10)} ${startTimeStr.substring(11, 13)}æ™‚`;

                    container.innerHTML += `
                        <div class="weather-card">
                            <div class="time-title">${timeString}</div>
                            <div class="icon">${icon}</div>
                            <div class="status">${wx}</div>
                            <div class="ci-text" style="background:${comfortData.color};">${comfortData.text}</div>
                            <div class="temp-range">${minT}Â° - ${maxT}Â°C</div>
                            <div class="rain">â˜” é™é›¨ç‡ï¼š${pop}%</div>
                            <div class="details-row">é«”æ„Ÿï¼š${at}Â°C | æ¿•åº¦ï¼š${rh}%</div> 
                        </div>
                    `;
                    weatherReportText += `\nâ° ${copyTime} èµ·ï¼š\n${icon} ${wx} / ğŸŒ¡ï¸${minT}-${maxT}Â°C / é«”æ„Ÿ${at}Â°C / æ¿•åº¦${rh}% / â˜”${pop}%`;
                }
                localStorage.setItem('myWeatherCity', city); 

            } catch (error) {
                console.error(error);
                let errorMessage = error.message.includes('è·¨åŸŸ') ? "è·¨åŸŸéŒ¯èª¤ï¼è«‹å•Ÿç”¨ç€è¦½å™¨ CORS æ“´å……åŠŸèƒ½ã€‚" : `API è«‹æ±‚å¤±æ•—ï¼š${error.message}`;
                container.innerHTML = `<div style="color:red; font-weight:bold; background:#ffe6e6; padding:15px; border-radius:10px;">âŒ éŒ¯èª¤ï¼šå¤©æ°£è³‡æ–™ç„¡æ³•è®€å–ã€‚<br>åŸå› ï¼š${errorMessage}</div>`;
                updatedTimeEl.innerText = '';
            } finally {
                 loader.style.display = 'none';
                 refreshMaps(); 
                 checkWarnings();
            }
        }


        async function checkWarnings() {
            const marquee = document.getElementById('alert-marquee');
            const marqueeText = document.getElementById('marqueeText');
            
            try {
                const data = await fetchCWAData('W-C0033-002'); 
                
                if (data.records.record.length > 0) {
                    activeWarningData = [];    
                    
                    data.records.record.forEach(item => {
                        const content = item.contents?.content?.contentText || ''; 
                        
                        if (content.trim() !== '' && !content.includes('è§£é™¤')) {
                            const title = item.datasetInfo.datasetDescription;    
                            const issueTimeRaw = item.datasetInfo.issueTime;    
                            const issueTime = issueTimeRaw ? issueTimeRaw.substring(5, 16) : "æœ€æ–°";    

                            let cleanContent = content.replace(/ã€‚/g, 'ã€‚<br>').replace(/\s+/g, ' ');    

                            activeWarningData.push({ title: title, time: issueTime, content: cleanContent });
                        }
                    });
                    
                    if (activeWarningData.length > 0) {
                        
                        // --- å‹•æ…‹è­¦å ±åˆ†ç´šèˆ‡æ‘˜è¦é‚è¼¯ ---
                        const isTyphoon = activeWarningData.some(a => a.title.includes('é¢±é¢¨'));
                        const isSevere = activeWarningData.some(a => isTyphoon || a.content.includes('è±ªé›¨') || a.content.includes('è¶…å¤§è±ªé›¨'));
                        const isRain = activeWarningData.some(a => a.content.includes('å¤§é›¨'));
                        const isCold = activeWarningData.some(a => a.content.includes('ä½æº«ç‰¹å ±'));
                        const isWind = activeWarningData.some(a => a.content.includes('å¤§é¢¨') || a.title.includes('å¼·é¢¨'));
                        const isFog = activeWarningData.some(a => a.content.includes('æ¿ƒéœ§'));
                        
                        let activeTypes = [];
                        if (isTyphoon) activeTypes.push('é¢±é¢¨');
                        if (isRain && !isSevere) activeTypes.push('å¤§é›¨');
                        if (isCold) activeTypes.push('ä½æº«');
                        if (isWind) activeTypes.push('å¼·é¢¨');
                        if (isFog) activeTypes.push('æ¿ƒéœ§');

                        let typeText = activeTypes.length > 0 ? activeTypes.join('/') : 'ä¸€èˆ¬ç‰¹å ±';


                        let summaryText;
                        
                        if (isSevere) {
                            summaryText = `ğŸ”´ é‡å¤§è­¦å ±ï¼š${typeText}ç­‰ ${activeWarningData.length} å‰‡ (è³‡æ–™ä¾†æº: CWA)ï¼Œé»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼`;
                            marquee.style.backgroundColor = 'var(--severe-color)';
                        } else if (isRain || isCold || isWind || isFog) {
                            summaryText = `âš ï¸ ç‰¹å ±ï¼š${typeText}ç­‰ ${activeWarningData.length} å‰‡ (è³‡æ–™ä¾†æº: CWA)ï¼Œé»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼`;
                            marquee.style.backgroundColor = '#d35400'; 
                        } else {
                            summaryText = `ğŸ”µ æ³¨æ„ï¼šç›®å‰æœ‰ ${activeWarningData.length} å‰‡å¤©æ°£ç‰¹å ± (è³‡æ–™ä¾†æº: CWA)ï¼Œé»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼`;
                            marquee.style.backgroundColor = 'var(--info-color)';
                        }
                        
                        marqueeText.innerText = summaryText;
                        marquee.style.display = 'block';
                        
                    } else {
                        marquee.style.display = 'none';
                    }
                } else {
                    marquee.style.display = 'none';
                }
            } catch(e) {
                console.error('è­¦å ±è®€å–å¤±æ•—ï¼ŒåŸå› ï¼š', e);
                marquee.style.display = 'block';
                marquee.style.textAlign = 'center';
                marquee.style.backgroundColor = 'var(--severe-color)'; 
                let errorMessage = e.message.includes('è·¨åŸŸ') ? "è·¨åŸŸéŒ¯èª¤ï¼è«‹å•Ÿç”¨ç€è¦½å™¨ CORS æ“´å……åŠŸèƒ½ã€‚" : `ç¶²è·¯æˆ– API æ•…éšœã€‚`;
                marqueeText.innerText = `âŒ æ°£è±¡ç‰¹å ±è®€å–å¤±æ•—ï¼š${errorMessage}`;
            }
        }

        function startClock() {
            const clockEl = document.getElementById('liveClock');
            const dateEl = document.getElementById('liveDate');
            const greetingEl = document.getElementById('greetingText');
            const countdownEl = document.getElementById('countdown');

            function update() {
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                clockEl.innerText = `${h}:${m}:${s}`;
                const hour = now.getHours();
                
                let msg = "ä½ å¥½ï¼";
                if (hour < 6) msg = "å¤œæ·±äº†ï¼Œæ—©é»ä¼‘æ¯ ğŸŒ™";
                else if (hour < 11) msg = "æ—©å®‰ï¼Œä»Šå¤©ä¹Ÿæ˜¯ç¾å¥½çš„ä¸€å¤© â˜€ï¸";
                else if (hour < 14) msg = "åˆå®‰ï¼Œè¨˜å¾—åƒåˆé¤å–” ğŸ±";
                else if (hour < 18) msg = "ä¸‹åˆå¥½ï¼Œå–æ¯èŒ¶ä¼‘æ¯ä¸€ä¸‹ ğŸµ";
                else msg = "æ™šå®‰ï¼Œä»Šå¤©è¾›è‹¦äº† ğŸ ";
                greetingEl.innerText = msg;
                
                const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                dateEl.innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${days[now.getDay()]}`;

                // --- ğŸŒŸ è·¨å¹´å€’æ•¸è¨ˆæ™‚é‚è¼¯ ğŸŒŸ ---
                let currentYear = now.getFullYear();
                let nextYear = currentYear + 1;
                let targetDate = new Date(nextYear, 0, 1, 0, 0, 0, 0); 
                let label = "ğŸ‰ è·é›¢è·¨å¹´é‚„æœ‰";

                if (now.getMonth() === 0 && now.getDate() === 1 && now.getHours() < 1) {
                    label = "ğŸ† æ–°å¹´å¿«æ¨‚ï¼äº«å—æ–°çš„ä¸€å¹´ï¼";
                    targetDate = new Date(nextYear + 1, 0, 1, 0, 0, 0, 0);
                }
                
                const diff = targetDate - now;
                
                if (diff > 0) {
                    const dd = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hh = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const mm = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const ss = Math.floor((diff % (1000 * 60)) / 1000);
                    countdownEl.innerHTML = `${label} ${dd}å¤© <br>${hh}æ™‚ ${mm}åˆ† ${ss}ç§’`;
                } else {
                    countdownEl.innerText = label;    
                }
            }
            update();
            clearInterval(clockInterval);
            clockInterval = setInterval(update, 1000);
        }

        function updateAstroInfo(city) {
            const date = new Date();
            const option = { dateStyle: 'long', calendar: 'chinese', numberingSystem: 'hans' };
            try {
                const lunarDate = new Intl.DateTimeFormat('zh-TW', option).format(date);
                const cleanedLunar = lunarDate.split('å¹´')[1].replace('å¹´', ''); 
                document.getElementById('lunarDate').innerText = `ğŸŒ è¾²æ›†ï¼š${cleanedLunar}`;
            } catch(e) { document.getElementById('lunarDate').innerText = "ğŸŒ è¾²æ›†è¨ˆç®—å¤±æ•—"; }
        }


        function toggleTheme(el) {
            const body = document.body;
            const isDarkMode = body.classList.contains('dark-mode');
            const btnMode = document.getElementById('btnMode');

            if (el && el.id === 'btnMode') {
                body.classList.toggle('dark-mode');
                const isDark = body.classList.contains('dark-mode');
                if (isDark) {
                    btnMode.innerText = "â˜€ï¸ æ—¥é–“";
                    body.style.background = '';    
                    localStorage.setItem('theme', 'dark');
                } else {
                    btnMode.innerText = "ğŸŒ™ å¤œé–“";
                    const savedGrad = localStorage.getItem('themeGradient') || 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)';
                    document.body.style.background = savedGrad; 
                    localStorage.setItem('theme', 'light');
                }
                return;
            }

            if (el && el.getAttribute('data-color')) {
                const color = el.getAttribute('data-color');
                const gradient = el.getAttribute('data-gradient');
                
                document.documentElement.style.setProperty('--main-color', color);
                
                if (!isDarkMode) {
                    document.body.style.background = gradient;
                }
                
                localStorage.setItem('themeColor', color);
                localStorage.setItem('themeGradient', gradient);

                document.querySelectorAll('#themeSelector .color-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-color') === color) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        function getCustomComfort(min, max) {
            min = parseInt(min); max = parseInt(max);
            const check = (t) => {
                if (t <= 10) return "ğŸ¥¶ éå¸¸å¯’å†·"; if (t <= 15) return "ğŸ§¥ å¯’å†·";
                if (t <= 19) return "ğŸ§£ åå†·"; if (t <= 25) return "ğŸƒ åæ¶¼";
                if (t <= 29) return "ğŸ˜Š èˆ’é©"; return "ğŸ¥µ æ‚¶ç†±";
            };
            const minText = check(min); const maxText = check(max);
            let color = "#b2bec3";
            const avg = (min + max) / 2;
            if (avg <= 10) color = "#2d3436"; else if (avg <= 15) color = "#0984e3";    
            else if (avg <= 19) color = "#74b9ff"; else if (avg <= 25) color = "#00b894";    
            else if (avg <= 29) color = "#fdcb6e"; else color = "#e17055";             
            let finalText = minText;
            if (minText !== maxText) finalText = `${minText}<br>~<br>${maxText}`;
            return { text: finalText, color: color };
        }
        
        function copyWeather() { 
            if (!weatherReportText) { alert("è«‹å…ˆæŸ¥è©¢å¤©æ°£ï¼"); return; } 
            navigator.clipboard.writeText(weatherReportText + "\n(ä¾†è‡ªæˆ‘çš„æ™ºæ…§å¤©æ°£App)").then(() => alert("âœ… è¤‡è£½æˆåŠŸï¼")).catch(() => alert("è¤‡è£½å¤±æ•—")); 
        }
        
        function saveLocation() { 
            localStorage.setItem('myWeatherCity', document.getElementById('citySelect').value); 
        }

        window.onload = function() {
            // ğŸŒŸ 1. å„ªå…ˆåˆå§‹åŒ–æ™‚é˜
            startClock();
            
            // 2. è¨­ç½®åœ°é»
            const savedCity = localStorage.getItem('myWeatherCity');
            const citySelectEl = document.getElementById('citySelect');
            if (savedCity && Array.from(citySelectEl.options).some(opt => opt.value === savedCity)) {
                citySelectEl.value = savedCity;
            } else {
                citySelectEl.value = "è‡ºåŒ—å¸‚";
            }
            
            // ğŸŒŸ 3. è¨­ç½®ä¸»é¡Œ
            const savedColor = localStorage.getItem('themeColor');
            const savedGrad = localStorage.getItem('themeGradient');
            const savedTheme = localStorage.getItem('theme');

            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('btnMode').innerText = "â˜€ï¸ æ—¥é–“";
            } else if (savedColor && savedGrad) {
                document.documentElement.style.setProperty('--main-color', savedColor);
                document.body.style.background = savedGrad;
                
                document.querySelectorAll('#themeSelector .color-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-color') === savedColor) {
                        btn.classList.add('active');
                    }
                });
            } else {
                document.querySelector('.theme-blue').classList.add('active');
            }

            // ğŸŒŸ 4. åˆå§‹åŒ–åœ°åœ–é‡˜é¸ç‹€æ…‹ä¸¦æ’åº
            const savedPins = localStorage.getItem('pinnedMaps');
            if (savedPins) {
                try {
                    pinnedMaps = JSON.parse(savedPins);
                } catch(e) {
                    console.error("Failed to parse pinnedMaps from localStorage:", e);
                    pinnedMaps = [];
                }
            }
            reorderMaps(); // æ ¹æ“šå„²å­˜çš„ç‹€æ…‹é€²è¡Œç¬¬ä¸€æ¬¡æ’åº

            // ğŸŒŸ 5. ç«‹å³é–‹å§‹æŸ¥è©¢ 
            getWeather(citySelectEl.value);
            
            // ğŸŒŸ 6. å®šæœŸæ›´æ–°åœ°åœ–ã€è­¦å ± (3åˆ†é˜)
            setInterval(function() {
                checkWarnings();
                // ğŸŒŸ ç§»é™¤äº† checkEarthquakeAlert() 
                refreshMaps(); // åªåˆ·æ–°åœ°åœ–åœ–ç‰‡
            }, 180000); // 180000 æ¯«ç§’ = 3 åˆ†é˜
        };
    </script>
</body>

</html>
