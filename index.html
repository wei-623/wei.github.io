<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§å¤©æ°£è¬èƒ½æ›†</title>
    
    <meta name="theme-color" content="#0984e3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi5pZ6aF5aSp5rCj6JCs6IO95puGIiwic2hvcnRfbmFtZSI6IuaZuua1jOWkqeawoyIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMwOTg0ZTMiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4tanRpZmZ5LmNvbS9pbWFnZXMvZ2VuZXJhdGVkLWljb24ucG5nIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">

    <style>
        :root {
            /* é è¨­ä¸»é¡Œ (è—è‰²) */
            --main-color: #0984e3;
            --bg-gradient: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            
            --card-bg-light: #fff;
            --card-bg-dark: rgba(30, 30, 40, 0.85);
            --text-main-light: #333;
            --text-main-dark: #fff;
            --container-bg-light: rgba(255, 255, 255, 0.95);
            --container-bg-dark: rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: var(--text-main-light);
            transition: background 0.5s ease, color 0.5s ease;
            overflow-x: hidden;
        }

        /* ğŸš¨ è­¦å ±æ©«å¹… (å…§åµŒæ–¼å®¹å™¨å…§) */
        #alert-marquee {
            width: 95%; /* ä½”æ“šå®¹å™¨å¯¬åº¦ */
            margin: 10px auto 20px auto; /* å±…ä¸­ä¸¦èˆ‡å…§å®¹å€éš” */
            background-color: #d63031; 
            color: white; 
            font-weight: bold; 
            z-index: 999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            display: none; 
            overflow: hidden; 
            font-size: 1.1em; 
            cursor: pointer; 
            transition: all 0.2s;
            text-align: center;
            border-radius: 10px;
        }
        
        .alert-summary { 
            padding: 10px 15px; 
            line-height: 1.4;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* è­¦å ±è©³æƒ…å€å¡Š */
        #alertDetails {
            display: none; 
            padding: 15px 20px;
            background-color: rgba(0,0,0,0.2);
            backdrop-filter: blur(5px);
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
            border-top: 1px solid rgba(255,255,255,0.3);
            font-size: 0.9em;
        }
        
        /* è­¦å ±åˆ†ç´šèƒŒæ™¯è‰² */
        .alert-bg-warning { background-color: #f39c12 !important; } /* é»ƒè‰²è­¦æˆ’ */
        .alert-bg-severe { background-color: #e74c3c !important; }  /* ç´…è‰²å±éšª */
        .alert-bg-info { background-color: #3498db !important; }    /* è—è‰²è³‡è¨Š */
        .alert-bg-default { background-color: #d63031 !important; } /* é è¨­åš´é‡ */
        
        /* è©³æƒ…åˆ—è¡¨é …ç›® */
        .alert-item {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed rgba(255,255,255,0.2);
        }
        .alert-item-title {
            font-weight: bold;
            font-size: 1.2em;
            color: #ffeb3b; /* æ¨™é¡Œé»ƒè‰² */
            margin-bottom: 5px;
            display: block;
        }
        .alert-item-content {
            font-size: 0.9em;
            line-height: 1.5;
            word-wrap: break-word;
        }


        body.dark-mode { background: linear-gradient(to bottom, #0f0c29, #302b63, #24243e) !important; color: var(--text-main-dark); }
        body.dark-mode::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0));
            background-repeat: repeat; background-size: 200px 200px; z-index: -1; opacity: 0.8;
            animation: starsMove 100s linear infinite;
        }
        @keyframes starsMove { from { background-position: 0 0; } to { background-position: 1000px 500px; } }

        .container {
            background: var(--container-bg-light); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); text-align: center; max-width: 1100px; width: 100%; min-height: 600px; transition: background 0.5s ease;
        }
        body.dark-mode .container { background: var(--container-bg-dark); box-shadow: 0 15px 35px rgba(0,0,0,0.8); }

        h2 { margin-top: 0; margin-bottom: 5px;}
        .clock-area { margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        body.dark-mode .clock-area { border-bottom: 1px solid rgba(255,255,255,0.2); }
        .greeting { font-size: 1.2em; color: var(--main-color); font-weight: bold; margin-bottom: 5px; }
        body.dark-mode .greeting { color: #74b9ff; }
        .real-time-clock { font-size: 2.8em; font-weight: bold; font-family: monospace; letter-spacing: 2px; margin: 10px 0;}
        
        .countdown-text { 
            font-size: 1.1em; 
            color: #e17055; 
            font-weight: bold; 
            margin: 10px 0; 
            background: rgba(225, 112, 85, 0.1); 
            display: inline-block; 
            padding: 5px 15px; 
            border-radius: 20px;
            /* ğŸŒŸ æ ¸å¿ƒä¿®å¾©ï¼šé¿å…å€’æ•¸æ–‡å­—æ›è¡Œï¼Œå¼·åˆ¶å–®è¡Œé¡¯ç¤º */
            white-space: nowrap; 
        }
        body.dark-mode .countdown-text { color: #ff7675; background: rgba(255, 118, 117, 0.2); }

        .astro-info { display: flex; justify-content: center; gap: 20px; font-size: 0.95em; color: #666; margin-top: 10px; flex-wrap: wrap; }
        body.dark-mode .astro-info { color: #b2bec3; }

        .controls { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        select, button { padding: 10px 18px; font-size: 16px; border-radius: 50px; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; outline: none; transition: 0.3s; }
        
        body.dark-mode select { background-color: #2d3436; color: #fff; border-color: #555; }
        body.dark-mode option { background-color: #2d3436; color: #fff; }
        
        .btn-query { background-color: var(--main-color); color: white; border: none; font-weight: bold; }
        .btn-copy { background-color: #00b894; color: white; border: none; font-weight: bold; }
        .btn-mode { background-color: #636e72; color: white; border: none; font-weight: bold; }
        .btn-gps { background-color: #e17055; color: white; border: none; font-weight: bold; }

        /* ğŸŸ¢ ä¸»é¡Œè‰²é¸æ“‡å™¨ */
        .theme-selector { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px;}
        .color-btn { 
            width: 25px; height: 25px; border-radius: 50%; 
            border: 2px solid transparent; 
            cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .theme-blue { background: #0984e3; }
        .theme-green { background: #00b894; }
        .theme-purple { background: #6c5ce7; }
        .theme-pink { background: #e84393; }

        .color-btn.active { 
            box-shadow: 0 0 0 3px #fff, 0 0 0 5px var(--main-color); 
            transform: scale(1.1); 
        } 
        body.dark-mode .color-btn.active { 
            box-shadow: 0 0 0 3px #333, 0 0 0 5px var(--main-color); 
        }

        #forecast-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 20px; min-height: 200px; }
        .weather-card {
            background: var(--card-bg-light); padding: 20px; border-radius: 15px; width: 240px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05); border-top: 5px solid var(--main-color);
            transition: transform 0.2s; color: var(--text-main-light);
            display: flex; flex-direction: column; align-items: center; animation: fadeIn .5s ease-out;
        }

        .ci-text { font-size: .9em; color: #fff; margin: 8px 0; background: #b2bec3; padding: 6px 15px; border-radius: 20px; font-weight: bold; width: 90%; }
        .temp-range { color: #e17055; font-weight: bold; font-size: 1.3em; margin-top: 5px;}
        .rain { color: var(--main-color); font-weight: bold; margin-top: 8px; font-size: .95em;}

        .map-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid rgba(0,0,0,.1); text-align: center; }
        body.dark-mode .map-section { border-top: 1px solid rgba(255,255,255,.1); }
        .map-section h3 { color: #555; margin-bottom: 20px; font-size: 1.4em; }
        body.dark-mode .map-section h3 { color: #ddd; }
        
        /* ğŸŒŸ åœ°åœ–ä½ˆå±€èª¿æ•´ï¼šæ¯è¡Œ 3 å€‹åœ–è¡¨ */
        .maps-wrapper { 
            display: grid; 
            grid-template-columns: repeat(3, minmax(280px, 1fr)); /* ç¢ºä¿æ¯è¡Œ 3 å€‹ */
            justify-content: center; 
            gap: 20px; 
            margin: 0 auto;
        }
        
        /* é‡å°çª„è¢å¹•/æ‰‹æ©Ÿ (å°æ–¼ 1000px æ™‚è§¸ç™¼) */
        @media (max-width: 1000px) {
            .maps-wrapper {
                /* æ‰‹æ©Ÿä½ˆå±€: æ¯è¡Œ 2 å€‹åœ–è¡¨ */
                grid-template-columns: repeat(auto-fit, minmax(45%, 1fr)); 
            }
        }
        
        .map-box { 
            max-width: 400px; 
            background: #fff; 
            padding: 15px; 
            border-radius: 15px; 
            box-shadow: 0 5px 15px rgba(0,0,0,.1); 
            width: 100%;
        }
        
        body.dark-mode .map-box { background: rgba(255,255,255,.1); }
        .map-box h4 { margin: 0 0 10px 0; color: var(--main-color); }
        img.map-img { width: 100%; height: auto; border-radius: 10px; display: block; }

        /* é€£çµé¡è‰²ä¿®å¾© (ç¢ºä¿åœ¨æ·±è‰²èƒŒæ™¯ä¸Šå¯è¦‹) */
        .link-btn {
            color: #fff !important; 
            background-color: var(--main-color);
            padding: 5px 10px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-top: 10px;
        }

        .footer-note { 
            margin-top: 30px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,.1); 
            font-size: .85em; color: #666; line-height: 1.6;
        }
        body.dark-mode .footer-note { color: #aaa; border-top-color: rgba(255,255,255,.1); }
    </style>
</head>
<body>

    <div class="container" id="mainCard">
        <h2 id="appTitle">ğŸ‡¹ğŸ‡¼ æ™ºæ…§å¤©æ°£è¬èƒ½æ›†</h2>

        <div id="alert-marquee" onclick="toggleAlertDetails()" data-state="summary" style="display: none;">
            <div class="alert-summary" id="marqueeText">è®€å–ç½å®³è­¦å ±ä¸­...</div>
            <div id="alertDetails" style="display:none;">
                </div>
        </div>
        
        <div class="clock-area">
            <div class="greeting" id="greetingText">Loading...</div>
            <div class="real-time-clock" id="liveClock">00:00:00</div>
            <div id="liveDate">--</div>
            
            <div id="countdown" class="countdown-text">è¨ˆç®—ä¸­...</div>

            <div class="astro-info">
                <span id="lunarDate">ğŸŒ è¾²æ›†...</span> | <span id="sunInfo">ğŸŒ… æ—¥å‡º...</span>
            </div>
        </div>
        
        <div class="controls">
            <select id="citySelect" onchange="saveLocation()">
                <option value="å®œè˜­ç¸£">å®œè˜­ç¸£</option><option value="è‡ºåŒ—å¸‚" selected>è‡ºåŒ—å¸‚</option>
                <option value="æ–°åŒ—å¸‚">æ–°åŒ—å¸‚</option><option value="æ¡ƒåœ’å¸‚">æ¡ƒåœ’å¸‚</option>
                <option value="è‡ºä¸­å¸‚">è‡ºä¸­å¸‚</option><option value="è‡ºå—å¸‚">è‡ºå—å¸‚</option>
                <option value="é«˜é›„å¸‚">é«˜é›„å¸‚</option><option value="åŸºéš†å¸‚">åŸºéš†å¸‚</option>
                <option value="æ–°ç«¹å¸‚">æ–°ç«¹å¸‚</option><option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                <option value="æ–°ç«¹ç¸£">æ–°ç«¹ç¸£</option><option value="è‹—æ —ç¸£">è‹—æ —ç¸£</option>
                <option value="å½°åŒ–ç¸£">å½°åŒ–ç¸£</option><option value="å—æŠ•ç¸£">å—æŠ•ç¸£</option>
                <option value="é›²æ—ç¸£">é›²æ—ç¸£</option><option value="å˜‰ç¾©ç¸£">å˜‰ç¾©ç¸£</option>
                <option value="å±æ±ç¸£">å±æ±ç¸£</option><option value="èŠ±è“®ç¸£">èŠ±è“®ç¸£</option>
                <option value="è‡ºæ±ç¸£">è‡ºæ±ç¸£</option><option value="æ¾æ¹–ç¸£">æ¾æ¹–ç¸£</option>
                <option value="é‡‘é–€ç¸£">é‡‘é–€ç¸£</option><option value="é€£æ±Ÿç¸£">é€£æ±Ÿç¸£</option>
            </select>
            <button class="btn-gps" onclick="getGPSLocation()">ğŸ“ å®šä½</button>
            <button class="btn-query" onclick="getWeather()">ğŸ”„ æŸ¥è©¢</button>
            <button class="btn-copy" onclick="copyWeather()">ğŸ“‹ è¤‡è£½</button>
            <button class="btn-mode" onclick="toggleTheme(this)" id="btnMode">ğŸŒ™ å¤œé–“</button>
            
            <div class="theme-selector" id="themeSelector">
                <div class="color-btn theme-blue active" data-color="#0984e3" data-gradient="linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)" onclick="toggleTheme(this)"></div>
                <div class="color-btn theme-green" data-color="#00b894" data-gradient="linear-gradient(135deg, #55efc4 0%, #00b894 100%)" onclick="toggleTheme(this)"></div>
                <div class="color-btn theme-purple" data-color="#6c5ce7" data-gradient="linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%)" onclick="toggleTheme(this)"></div>
                <div class="color-btn theme-pink" data-color="#e84393" data-gradient="linear-gradient(135deg, #fd79a8 0%, #e84393 100%)" onclick="toggleTheme(this)"></div>
            </div>
        </div>
        
        <div class="loader" id="loader"></div>
        <div id="forecast-container"></div>
        
        <div class="map-section">
            <h3>ğŸŒ å…¨å°å¤©æ°£å¯¦æ³</h3>
            <div class="maps-wrapper">
                <div class="map-box" style="order: 1;">
                    <h4>ğŸŒ¡ï¸ æº«åº¦åˆ†å¸ƒ</h4>
                    <a id="tempLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg" target="_blank"><img id="tempMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡æº«åº¦è³‡æ–™';"></a>
                    <a id="tempBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>
                
                <div class="map-box" style="order: 2;">
                    <h4>â˜” æ—¥ç´¯ç©é›¨é‡</h4>
                    <a id="rainLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg" target="_blank"><img id="rainMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg" target="_blank" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é›¨é‡è³‡æ–™';"></a>
                    <a id="rainBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                <div class="map-box" style="order: 3;">
                    <h4>ğŸ—ºï¸ åœ°é¢å¤©æ°£åœ–</h4>
                    <a id="surfaceLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Forecast/F-C0035-001.jpg" target="_blank"><img id="surfaceMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Forecast/F-C0035-001.jpg" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡å¤©æ°£åœ–è³‡æ–™';"></a>
                    <a id="surfaceBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Forecast/F-C0035-001.jpg" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>
                
                <div class="map-box" style="order: 4;">
                    <h4>æ¨¹æ—é›·é”å›æ³¢åœ–</h4>
                    <a id="shulinLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-001.png" target="_blank"><img id="shulinMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-001.png" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é›·é”è³‡æ–™';"></a>
                    <a id="shulinBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-001.png" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                <div class="map-box" style="order: 5;">
                    <h4>å—å±¯é›·é”å›æ³¢åœ–</h4>
                    <a id="nantunLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-002.png" target="_blank"><img id="nantunMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-002.png" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é›·é”è³‡æ–™';"></a>
                    <a id="nantunBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-002.png" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

                <div class="map-box" style="order: 6;">
                    <h4>æ—åœ’é›·é”å›æ³¢åœ–</h4>
                    <a id="linyuanLink" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-003.png" target="_blank"><img id="linyuanMap" class="map-img" src="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-003.png" alt="è®€å–ä¸­..." onerror="this.src='https://via.placeholder.com/600x400?text=ç„¡é›·é”è³‡æ–™';"></a>
                    <a id="linyuanBtn" href="https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-003.png" target="_blank" class="link-btn">ğŸ”— é–‹å•ŸåŸåœ–</a>
                </div>

            </div>
        </div>

        <div class="footer-note">
            âš ï¸ å‚™è¨»ï¼šå„ç¸£å¸‚é å ±ä¿‚ä»¥å„ç¸£å¸‚æ”¿åºœæ‰€åœ¨åœ°é™„è¿‘ç‚ºé å ±åƒè€ƒä½ç½®ã€‚<br>
            â³ æ—¥å‡ºæ—¥è½æ™‚é–“æ¡ç”¨é€šç”¨å¤©æ–‡æ¼”ç®—æ³•ï¼Œå¯èƒ½èˆ‡æ°£è±¡ç½²å®˜æ–¹è§€æ¸¬æœ‰ 1~2 åˆ†é˜èª¤å·®ã€‚
        </div>
    </div>

    <script>
        let weatherReportText = "";
        let currentWxStatus = ""; 
        let clockInterval;
        let activeWarningData = []; 

        const apiKey = 'CWA-F34E2B5F-6154-4EBF-987B-9E10BE9C365C'; 

        const cityCoords = {
            "è‡ºåŒ—å¸‚": {lat: 25.0329, lon: 121.5654}, "åŸºéš†å¸‚": {lat: 25.1276, lon: 121.7391},
            "æ–°åŒ—å¸‚": {lat: 25.0169, lon: 121.4627}, "å®œè˜­ç¸£": {lat: 24.7021, lon: 121.7377},
            "æ¡ƒåœ’å¸‚": {lat: 24.9936, lon: 121.3009}, "æ–°ç«¹å¸‚": {lat: 24.8138, lon: 120.9674},
            "æ–°ç«¹ç¸£": {lat: 24.8396, lon: 121.0180}, "è‹—æ —ç¸£": {lat: 24.5601, lon: 120.8214},
            "è‡ºä¸­å¸‚": {lat: 24.1477, lon: 120.6736}, "å½°åŒ–ç¸£": {lat: 24.0517, lon: 120.5160},
            "å—æŠ•ç¸£": {lat: 23.9609, lon: 120.6951}, "é›²æ—ç¸£": {lat: 23.7092, lon: 120.4313},
            "å˜‰ç¾©å¸‚": {lat: 23.4800, lon: 120.4491}, "å˜‰ç¾©ç¸£": {lat: 23.4518, lon: 120.2554},
            "è‡ºå—å¸‚": {lat: 22.9997, lon: 120.2270}, "é«˜é›„å¸‚": {lat: 22.6272, lon: 120.3014},
            "å±æ±ç¸£": {lat: 22.5519, lon: 120.5487}, "è‡ºæ±ç¸£": {lat: 22.7972, lon: 121.0713},
            "èŠ±è“®ç¸£": {lat: 23.9871, lon: 121.6015}, "æ¾æ¹–ç¸£": {lat: 23.5711, lon: 119.5793},
            "é‡‘é–€ç¸£": {lat: 24.3293, lon: 118.3204}, "é€£æ±Ÿç¸£": {lat: 26.1512, lon: 119.9288}
        };

        const sampleSurfaceMapData = {
            "cwaopendata": {
                "Sent": "2025-12-10T11:17:05+08:00",
                "Dataset": {
                    "Resource": {
                        "ProductURL": "https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Forecast/F-C0035-001.jpg"
                    }
                }
            }
        };

        const sampleNantunRadarData = { "cwaopendata": { "Sent": "2025-12-10T22:29:15+08:00", "Dataset": { "Resource": { "ProductURL": "https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-002.png" } } } };
        const sampleShulinRadarData = { "cwaopendata": { "Sent": "2025-12-10T22:29:43+08:00", "Dataset": { "Resource": { "ProductURL": "https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-001.png" } } } };
        const sampleLinyuanRadarData = { "cwaopendata": { "Sent": "2025-12-10T22:45:03+08:00", "Dataset": { "Resource": { "ProductURL": "https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0084-003.png" } } } };


        function updateSurfaceMap(data) {
            const url = data.cwaopendata.Dataset.Resource.ProductURL;

            document.getElementById('surfaceMap').src = url;
            document.getElementById('surfaceLink').href = url;
            document.getElementById('surfaceBtn').href = url;
        }

        // ğŸŒŸ æ–°å¢é›·é”åœ–è¼‰å…¥èˆ‡æ™‚é–“æ›´æ–°
        function updateRadarMap(data, imgId, linkId, btnId) {
            const url = data.cwaopendata.Dataset.Resource.ProductURL;

            document.getElementById(imgId).src = url;
            document.getElementById(linkId).href = url;
            document.getElementById(btnId).href = url;
        }


        function toggleAlertDetails() {
            const marquee = document.getElementById('alert-marquee');
            const details = document.getElementById('alertDetails');
            const currentState = marquee.getAttribute('data-state');

            if (currentState === 'summary' && activeWarningData.length > 0) {
                // å±•é–‹è©³æƒ…
                let detailHtml = activeWarningData.map(alert => {
                    // ğŸŒŸ è­¦å ±å…§å®¹åˆ†è¡Œå„ªåŒ–ï¼šå°‡å¥è™Ÿæ›¿æ›ç‚ºæ›è¡Œ
                    const formattedContent = alert.content.replace(/ã€‚/g, 'ã€‚<br>');

                    return `<div class="alert-item">
                        <span class="alert-item-title">${alert.title}</span>
                        <span style="font-size:0.8em; color:#bbb;">ç™¼å¸ƒæ™‚é–“: ${alert.time}</span><br>
                        <span class="alert-item-content">${formattedContent}</span>
                    </div>`;
                }).join('');
                
                details.innerHTML = detailHtml;
                details.style.display = 'block';
                marquee.setAttribute('data-state', 'detailed');
            } else {
                // æ”¶èµ·è©³æƒ…
                details.style.display = 'none';
                marquee.setAttribute('data-state', 'summary');
            }
        }


        async function getWeather() {
            const citySelect = document.getElementById('citySelect');
            if (!citySelect.value) citySelect.value = "è‡ºåŒ—å¸‚";
            const city = citySelect.value;
            const container = document.getElementById('forecast-container');
            const loader = document.getElementById('loader');

            container.innerHTML = '';
            loader.style.display = 'block';
            container.innerHTML = '<p>æ­£åœ¨ç²å–æœ€æ–°ç¸£å¸‚é å ±...</p>';
            weatherReportText = `ğŸ“… ${city} å¤©æ°£é å ±ï¼š\n`; 

            updateAstroInfo(city);
            
            // 1. ğŸŒŸ åœ°åœ–åœ–ç‰‡å’Œéœæ…‹ä¿¡æ¯è¼‰å…¥
            document.getElementById('tempMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg`;
            document.getElementById('rainMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg`;
            updateSurfaceMap(sampleSurfaceMapData); 

            // ğŸŒŸ è¼‰å…¥é›·é”åœ– (éœæ…‹ URL)
            updateRadarMap(sampleShulinRadarData, 'shulinMap', 'shulinLink', 'shulinBtn');
            updateRadarMap(sampleNantunRadarData, 'nantunMap', 'nantunLink', 'nantunBtn');
            updateRadarMap(sampleLinyuanRadarData, 'linyuanMap', 'linyuanLink', 'linyuanBtn');

            // 2. ç•°æ­¥ç²å–è­¦å ± (ä¸é˜»å¡ä¸»ç·šç¨‹)
            checkWarnings(); 

            const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${apiKey}&locationName=${city}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 401) throw new Error("API Key ç„¡æ•ˆæˆ–éæœŸ");
                    throw new Error(`ç¶²è·¯æˆ–æœå‹™éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success === "true") {
                    loader.style.display = 'none';
                    const locationData = data.records.location[0];
                    const weatherElements = locationData.weatherElement;
                    currentWxStatus = weatherElements.find(el => el.elementName === 'Wx').time[0].parameter.parameterName;
                    
                    // æ¸…ç©ºå®¹å™¨ï¼Œæº–å‚™æ¸²æŸ“æ–°çš„é å ±å¡ç‰‡
                    container.innerHTML = '';
                    
                    for (let i = 0; i < 3; i++) {
                        const startTimeStr = weatherElements[0].time[i].startTime;
                        const endTimeStr = weatherElements[0].time[i].endTime;
                        const wx = weatherElements.find(el => el.elementName === 'Wx').time[i].parameter.parameterName;
                        const pop = weatherElements.find(el => el.elementName === 'PoP').time[i].parameter.parameterName;
                        const minT = weatherElements.find(el => el.elementName === 'MinT').time[i].parameter.parameterName;
                        const maxT = weatherElements.find(el => el.elementName === 'MaxT').time[i].parameter.parameterName;
                        const comfortData = getCustomComfort(minT, maxT);

                        let icon = 'â˜ï¸';
                        if (wx.includes('é›·')) icon = 'â›ˆï¸';
                        else if (wx.includes('é›¨')) icon = 'ğŸŒ§ï¸';
                        else if (wx.includes('æ™´')) icon = 'â˜€ï¸';
                        else if (wx.includes('é™°') || wx.includes('é›²')) icon = 'â˜ï¸';

                        const timeString = `${startTimeStr.substring(5, 16)} <br>~<br> ${endTimeStr.substring(5, 16)}`;
                        const copyTime = `${startTimeStr.substring(5, 10)} ${startTimeStr.substring(11, 13)}æ™‚`;

                        container.innerHTML += `
                            <div class="weather-card">
                                <div class="time-title">${timeString}</div>
                                <div class="icon">${icon}</div>
                                <div class="status">${wx}</div>
                                <div class="ci-text" style="background:${comfortData.color};">${comfortData.text}</div>
                                <div class="temp-range">${minT}Â° - ${maxT}Â°C</div>
                                <div class="rain">â˜” é™é›¨ç‡ï¼š${pop}%</div>
                            </div>
                        `;
                        weatherReportText += `\nâ° ${copyTime} èµ·ï¼š\n${icon} ${wx} / ğŸŒ¡ï¸${minT}-${maxT}Â°C / â˜”${pop}%`;
                    }
                    saveLocation();
                } else {
                    loader.style.display = 'none';
                    container.innerHTML = '<p>è®€å–å¤±æ•—</p>';
                }
            } catch (error) {
                console.error(error);
                loader.style.display = 'none';
                container.innerHTML = `<div style="color:red; font-weight:bold; background:#ffe6e6; padding:15px; border-radius:10px;">âŒ éŒ¯èª¤ï¼šå¤©æ°£è³‡æ–™ç„¡æ³•è®€å–ã€‚<br>åŸå› ï¼š${error.message || 'API è«‹æ±‚å¤±æ•—'}</div></div>`;
            }
        }


        async function checkWarnings() {
            const marquee = document.getElementById('alert-marquee');
            const marqueeText = document.getElementById('marqueeText');
            
            const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/W-C0033-002?Authorization=${apiKey}&format=JSON`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.success === "true" && data.records.record.length > 0) {
                    activeWarningData = []; 
                    
                    data.records.record.forEach(item => {
                        const content = item.contents.content.contentText || '';
                        
                        if (content.trim() !== '' && !content.includes('è§£é™¤')) {
                            const title = item.datasetInfo.datasetDescription; 
                            const issueTimeRaw = item.datasetInfo.issueTime; 
                            const issueTime = issueTimeRaw ? issueTimeRaw.substring(5, 16) : "æœ€æ–°"; 

                            let cleanContent = content.replace(/\n/g, '').replace(/\s+/g, ' '); 

                            activeWarningData.push({ title: title, time: issueTime, content: cleanContent });
                        }
                    });
                    
                    if (activeWarningData.length > 0) {
                        
                        // ğŸŒŸ è­¦å ±åˆ†ç´šä¸¦ç”Ÿæˆæ‘˜è¦
                        let summaryText = `ğŸš¨ ç™¼ç¾ ${activeWarningData.length} å‰‡è­¦å ± (è³‡æ–™ä¾†æº: CWA)ï¼Œé»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼`;
                        let alertClass = 'alert-bg-default';
                        
                        if (activeWarningData.some(a => a.title.includes('é¢±é¢¨') || a.title.includes('åœ°éœ‡') || a.title.includes('è±ªé›¨'))) {
                            alertClass = 'alert-bg-severe';
                            summaryText = `ğŸ”´ é‡å¤§è­¦å ±ï¼šé¢±é¢¨/è±ªé›¨ç­‰ ${activeWarningData.length} å‰‡ (è³‡æ–™ä¾†æº: CWA)ï¼Œé»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼`;
                        } else if (activeWarningData.some(a => a.title.includes('å¤§é›¨') || a.title.includes('ä½æº«') || a.title.includes('å¤§é¢¨'))) {
                            alertClass = 'alert-bg-warning';
                            summaryText = `âš ï¸ ç‰¹å ±ï¼šå¤§é›¨/ä½æº«ç­‰ ${activeWarningData.length} å‰‡ (è³‡æ–™ä¾†æº: CWA)ï¼Œé»æ“ŠæŸ¥çœ‹è©³æƒ…ï¼`;
                        }
                        
                        marquee.className = `alert-marquee ${alertClass}`;
                        marqueeText.innerText = summaryText;
                        marquee.style.display = 'block';
                        
                    } else {
                        marquee.style.display = 'none';
                    }
                } else {
                    marquee.style.display = 'none';
                }
            } catch(e) {
                console.error('è­¦å ±è®€å–å¤±æ•—ï¼ŒåŸå› ï¼š', e);
                marquee.style.display = 'block';
                marquee.style.textAlign = 'center';
                marqueeText.innerText = 'ğŸš¨ è­¦å ±è³‡è¨Šè®€å–å¤±æ•— (è³‡æ–™ä¾†æº: CWA)';
            }
        }

        function startClock() {
            const clockEl = document.getElementById('liveClock');
            const dateEl = document.getElementById('liveDate');
            const greetingEl = document.getElementById('greetingText');
            const countdownEl = document.getElementById('countdown');

            function update() {
                const now = new Date();
                const h = String(now.getHours()).padStart(2, '0');
                const m = String(now.getMinutes()).padStart(2, '0');
                const s = String(now.getSeconds()).padStart(2, '0');
                clockEl.innerText = `${h}:${m}:${s}`;
                const hour = now.getHours();
                
                let msg = "ä½ å¥½ï¼";
                if (hour < 6) msg = "å¤œæ·±äº†ï¼Œæ—©é»ä¼‘æ¯ ğŸŒ™";
                else if (hour < 11) msg = "æ—©å®‰ï¼Œä»Šå¤©ä¹Ÿæ˜¯ç¾å¥½çš„ä¸€å¤© â˜€ï¸";
                else if (hour < 14) msg = "åˆå®‰ï¼Œè¨˜å¾—åƒåˆé¤å–” ğŸ±";
                else if (hour < 18) msg = "ä¸‹åˆå¥½ï¼Œå–æ¯èŒ¶ä¼‘æ¯ä¸€ä¸‹ ğŸµ";
                else msg = "æ™šå®‰ï¼Œä»Šå¤©è¾›è‹¦äº† ğŸ ";
                greetingEl.innerText = msg;
                
                const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                dateEl.innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${days[now.getDay()]}`;

                // --- ğŸŒŸ è·¨å¹´å€’æ•¸è¨ˆæ™‚é‚è¼¯ ğŸŒŸ ---
                let currentYear = now.getFullYear();
                let nextYear = currentYear + 1;
                let targetDate = new Date(nextYear, 0, 1, 0, 0, 0, 0); // ä¸‹ä¸€å€‹ 1 æœˆ 1 æ—¥ 00:00:00
                let label = "ğŸ‰ è·é›¢è·¨å¹´é‚„æœ‰";

                if (now.getMonth() === 0 && now.getDate() === 1 && now.getHours() < 1) {
                    label = "ğŸ† æ–°å¹´å¿«æ¨‚ï¼äº«å—æ–°çš„ä¸€å¹´ï¼";
                    targetDate = new Date(nextYear + 1, 0, 1, 0, 0, 0, 0);
                }
                
                const diff = targetDate - now;
                
                if (diff > 0) {
                    const dd = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hh = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const mm = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const ss = Math.floor((diff % (1000 * 60)) / 1000);
                    // ğŸŒŸ å€’æ•¸è¨ˆæ™‚ä½ˆå±€ä¿®å¾©
                    countdownEl.innerHTML = `${label} ${dd}å¤© <br>${hh}æ™‚ ${mm}åˆ† ${ss}ç§’`;
                } else {
                    countdownEl.innerText = label; 
                }
                // --- ğŸŒŸ è·¨å¹´å€’æ•¸è¨ˆæ™‚é‚è¼¯çµæŸ ğŸŒŸ ---

                // ğŸŒŸ è¾²æ›†åœ¨æ¯æ¬¡æ›´æ–°æ™‚è¢«æ›´æ–°
                updateAstroInfo(document.getElementById('citySelect').value);
            }
            update();
            clearInterval(clockInterval);
            clockInterval = setInterval(update, 1000);
        }

        function updateAstroInfo(city) {
            const date = new Date();
            // ğŸŒŸ è¾²æ›†ä¿®å¾©
            const option = { dateStyle: 'full', calendar: 'chinese', numberingSystem: 'hans' };
            try {
                const lunarDate = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', option).format(date);
                // ğŸŒŸ ç§»é™¤è¾²æ›†çš„è³‡æ–™ä¾†æºæ¨™è¨»
                document.getElementById('lunarDate').innerText = `ğŸŒ è¾²æ›†ï¼š${lunarDate.split(' ')[0]}`;
            } catch(e) { document.getElementById('lunarDate').innerText = "ğŸŒ è¾²æ›†è¨ˆç®—å¤±æ•—"; }
            const coords = cityCoords[city];
            if(coords) {
                const sunUrl = `https://api.sunrise-sunset.org/json?lat=${coords.lat}&lng=${coords.lon}&formatted=0`;
                fetch(sunUrl).then(res => res.json()).then(data => {
                    if(data.status === 'OK') {
                        const sunrise = new Date(data.results.sunrise);
                        const sunset = new Date(data.results.sunset);
                        const fmt = (d) => `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                        // ğŸŒŸ ç§»é™¤æ—¥å‡ºæ—¥è½çš„è³‡æ–™ä¾†æºæ¨™è¨»
                        document.getElementById('sunInfo').innerText = `ğŸŒ… æ—¥å‡º ${fmt(sunrise)} / ğŸŒ‡ æ—¥è½ ${fmt(sunset)}`;
                    }
                }).catch(() => { document.getElementById('sunInfo').innerText = "ğŸŒ… æ—¥å‡ºè®€å–å¤±æ•—"; });
            }
        }

        function getGPSLocation() {
            if (!navigator.geolocation) { alert("ä¸æ”¯æ´å®šä½"); return; }
            const btn = document.querySelector('.btn-gps');
            btn.innerText = "ğŸ“¡...";
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude; const lon = pos.coords.longitude;
                let minDist = Infinity; let nearest = "";
                for (const [c, co] of Object.entries(cityCoords)) {
                    const d = Math.sqrt(Math.pow(lat - co.lat, 2) + Math.pow(lon - co.lon, 2));
                    if (d < minDist) { minDist = d; nearest = c; }
                }
                if (nearest) {
                    alert(`å®šä½æˆåŠŸï¼åˆ‡æ›è‡³ï¼š${nearest}`);
                    document.getElementById('citySelect').value = nearest;
                    getWeather();
                }
                btn.innerText = "ğŸ“ å®šä½";
            }, () => { alert("å®šä½å¤±æ•—"); btn.innerText = "ğŸ“ å®šä½"; });
        }

        function toggleTheme(el) {
            const body = document.body;
            const isDarkMode = body.classList.contains('dark-mode');
            const btnMode = document.getElementById('btnMode');

            // è™•ç†å¤œé–“æ¨¡å¼åˆ‡æ›
            if (el && el.id === 'btnMode') {
                body.classList.toggle('dark-mode');
                const isDark = body.classList.contains('dark-mode');
                if (isDark) {
                    btnMode.innerText = "â˜€ï¸ æ—¥é–“";
                    body.style.background = ''; 
                    localStorage.setItem('theme', 'dark');
                } else {
                    btnMode.innerText = "ğŸŒ™ å¤œé–“";
                    const savedGrad = localStorage.getItem('themeGradient') || 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)';
                    body.style.background = savedGrad;
                    localStorage.setItem('theme', 'light');
                }
                return;
            }

            // è™•ç†é¡è‰²æŒ‰éˆ•é»æ“Š
            if (el && el.getAttribute('data-color')) {
                const color = el.getAttribute('data-color');
                const gradient = el.getAttribute('data-gradient');
                
                // 1. æ›´æ–° CSS è®Šæ•¸
                document.documentElement.style.setProperty('--main-color', color);
                
                // 2. åªæœ‰åœ¨éå¤œé–“æ¨¡å¼ä¸‹ï¼Œæ‰æ›´æ–° body èƒŒæ™¯
                if (!isDarkMode) {
                    document.body.style.background = gradient;
                }
                
                // 3. æ›´æ–° Local Storage
                localStorage.setItem('themeColor', color);
                localStorage.setItem('themeGradient', gradient);

                // 4. æ›´æ–° active ç‹€æ…‹
                document.querySelectorAll('#themeSelector .color-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                el.classList.add('active');
            }
        }

        function getCustomComfort(min, max) {
            min = parseInt(min); max = parseInt(max);
            const check = (t) => {
                if (t <= 10) return "ğŸ¥¶ éå¸¸å¯’å†·"; if (t <= 15) return "ğŸ§¥ å¯’å†·";
                if (t <= 19) return "ğŸ§£ åå†·"; if (t <= 25) return "ğŸƒ åæ¶¼";
                if (t <= 29) return "ğŸ˜Š èˆ’é©"; return "ğŸ¥µ æ‚¶ç†±";
            };
            const minText = check(min); const maxText = check(max);
            let color = "#b2bec3";
            const avg = (min + max) / 2;
            if (avg <= 10) color = "#2d3436"; else if (avg <= 15) color = "#0984e3"; 
            else if (avg <= 19) color = "#74b9ff"; else if (avg <= 25) color = "#00b894"; 
            else if (avg <= 29) color = "#fdcb6e"; else color = "#e17055";                
            let finalText = minText;
            if (minText !== maxText) finalText = `${minText}<br>~<br>${maxText}`;
            return { text: finalText, color: color };
        }
        function copyWeather() { if (!weatherReportText) { alert("è«‹å…ˆæŸ¥è©¢å¤©æ°£ï¼"); return; } navigator.clipboard.writeText(weatherReportText + "\n(ä¾†è‡ªæˆ‘çš„æ™ºæ…§å¤©æ°£App)").then(() => alert("âœ… è¤‡è£½æˆåŠŸï¼")).catch(() => alert("è¤‡è£½å¤±æ•—")); }
        function saveLocation() { localStorage.setItem('myWeatherCity', document.getElementById('citySelect').value); }

        function updateSurfaceMap(data) {
            const url = data.cwaopendata.Dataset.Resource.ProductURL;

            document.getElementById('surfaceMap').src = url;
            document.getElementById('surfaceLink').href = url;
            document.getElementById('surfaceBtn').href = url;
        }

        // ğŸŒŸ æ–°å¢é›·é”åœ–è¼‰å…¥èˆ‡æ™‚é–“æ›´æ–°
        function updateRadarMap(data, imgId, linkId, btnId) {
            const url = data.cwaopendata.Dataset.Resource.ProductURL;

            document.getElementById(imgId).src = url;
            document.getElementById(linkId).href = url;
            document.getElementById(btnId).href = url;
        }


        async function getWeather() {
            const citySelect = document.getElementById('citySelect');
            if (!citySelect.value) citySelect.value = "è‡ºåŒ—å¸‚";
            const city = citySelect.value;
            const container = document.getElementById('forecast-container');
            const loader = document.getElementById('loader');

            container.innerHTML = '';
            loader.style.display = 'block';
            container.innerHTML = '<p>æ­£åœ¨ç²å–æœ€æ–°ç¸£å¸‚é å ±...</p>';
            weatherReportText = `ğŸ“… ${city} å¤©æ°£é å ±ï¼š\n`; 

            updateAstroInfo(city);
            
            // 1. ğŸŒŸ åœ°åœ–åœ–ç‰‡å’Œéœæ…‹ä¿¡æ¯è¼‰å…¥
            document.getElementById('tempMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0038-001.jpg`;
            document.getElementById('rainMap').src = `https://cwaopendata.s3.ap-northeast-1.amazonaws.com/Observation/O-A0040-001.jpg`;
            updateSurfaceMap(sampleSurfaceMapData); 

            // ğŸŒŸ è¼‰å…¥é›·é”åœ– (éœæ…‹ URL)
            updateRadarMap(sampleShulinRadarData, 'shulinMap', 'shulinLink', 'shulinBtn');
            updateRadarMap(sampleNantunRadarData, 'nantunMap', 'nantunLink', 'nantunBtn');
            updateRadarMap(sampleLinyuanRadarData, 'linyuanMap', 'linyuanLink', 'linyuanBtn');

            // 2. ç•°æ­¥ç²å–è­¦å ± (ä¸é˜»å¡ä¸»ç·šç¨‹)
            checkWarnings(); 

            const url = `https://opendata.cwa.gov.tw/api/v1/rest/datastore/F-C0032-001?Authorization=${apiKey}&locationName=${city}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 401) throw new Error("API Key ç„¡æ•ˆæˆ–éæœŸ");
                    throw new Error(`ç¶²è·¯æˆ–æœå‹™éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success === "true") {
                    loader.style.display = 'none';
                    const locationData = data.records.location[0];
                    const weatherElements = locationData.weatherElement;
                    currentWxStatus = weatherElements.find(el => el.elementName === 'Wx').time[0].parameter.parameterName;
                    
                    // æ¸…ç©ºå®¹å™¨ï¼Œæº–å‚™æ¸²æŸ“æ–°çš„é å ±å¡ç‰‡
                    container.innerHTML = '';
                    
                    for (let i = 0; i < 3; i++) {
                        const startTimeStr = weatherElements[0].time[i].startTime;
                        const endTimeStr = weatherElements[0].time[i].endTime;
                        const wx = weatherElements.find(el => el.elementName === 'Wx').time[i].parameter.parameterName;
                        const pop = weatherElements.find(el => el.elementName === 'PoP').time[i].parameter.parameterName;
                        const minT = weatherElements.find(el => el.elementName === 'MinT').time[i].parameter.parameterName;
                        const maxT = weatherElements.find(el => el.elementName === 'MaxT').time[i].parameter.parameterName;
                        const comfortData = getCustomComfort(minT, maxT);

                        let icon = 'â˜ï¸';
                        if (wx.includes('é›·')) icon = 'â›ˆï¸';
                        else if (wx.includes('é›¨')) icon = 'ğŸŒ§ï¸';
                        else if (wx.includes('æ™´')) icon = 'â˜€ï¸';
                        else if (wx.includes('é™°') || wx.includes('é›²')) icon = 'â˜ï¸';

                        const timeString = `${startTimeStr.substring(5, 16)} <br>~<br> ${endTimeStr.substring(5, 16)}`;
                        const copyTime = `${startTimeStr.substring(5, 10)} ${startTimeStr.substring(11, 13)}æ™‚`;

                        container.innerHTML += `
                            <div class="weather-card">
                                <div class="time-title">${timeString}</div>
                                <div class="icon">${icon}</div>
                                <div class="status">${wx}</div>
                                <div class="ci-text" style="background:${comfortData.color};">${comfortData.text}</div>
                                <div class="temp-range">${minT}Â° - ${maxT}Â°C</div>
                                <div class="rain">â˜” é™é›¨ç‡ï¼š${pop}%</div>
                            </div>
                        `;
                        weatherReportText += `\nâ° ${copyTime} èµ·ï¼š\n${icon} ${wx} / ğŸŒ¡ï¸${minT}-${maxT}Â°C / â˜”${pop}%`;
                    }
                    saveLocation();
                } else {
                    loader.style.display = 'none';
                    container.innerHTML = '<p>è®€å–å¤±æ•—</p>';
                }
            } catch (error) {
                console.error(error);
                loader.style.display = 'none';
                container.innerHTML = `<div style="color:red; font-weight:bold; background:#ffe6e6; padding:15px; border-radius:10px;">âŒ éŒ¯èª¤ï¼šå¤©æ°£è³‡æ–™ç„¡æ³•è®€å–ã€‚<br>åŸå› ï¼š${error.message || 'API è«‹æ±‚å¤±æ•—'}</div></div>`;
            }
        }


        window.onload = function() {
            // 1. ğŸŒŸ å„ªå…ˆåˆå§‹åŒ–æ™‚é˜ã€è¾²æ›†å’Œå¤©æ–‡è³‡è¨Šï¼ˆç§’ç´šæ›´æ–°ï¼‰
            startClock();
            
            // 2. è¨­ç½®åœ°é»
            const savedCity = localStorage.getItem('myWeatherCity');
            if (savedCity) {
                document.getElementById('citySelect').value = savedCity;
            } else {
                document.getElementById('citySelect').value = "è‡ºåŒ—å¸‚";
            }

            // 3. è¨­ç½®ä¸»é¡Œ
            const savedColor = localStorage.getItem('themeColor');
            const savedGrad = localStorage.getItem('themeGradient');
            const savedTheme = localStorage.getItem('theme');

            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('btnMode').innerText = "â˜€ï¸ æ—¥é–“";
            } else if (savedColor && savedGrad) {
                document.documentElement.style.setProperty('--main-color', savedColor);
                document.body.style.background = savedGrad;
                
                document.querySelectorAll('#themeSelector .color-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-color') === savedColor) {
                        btn.classList.add('active');
                    }
                });
            } else {
                 document.querySelector('.theme-blue').classList.add('active');
            }

            // 4. ğŸŒŸ ç«‹å³é–‹å§‹å¤©æ°£æŸ¥è©¢ (åŒ…å«åœ°åœ–è¼‰å…¥å’Œè­¦å ±æª¢æŸ¥)
            getWeather();
        };
    </script>
</body>
</html>